#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ENV_FILE="${1:-$ROOT_DIR/.env}"
EXAMPLE_FILE="$ROOT_DIR/config/local_ai.env.example"

VISION_MODEL="${OLLAMA_VISION_MODEL:-llava:7b}"
BASE_MODEL="${OLLAMA_MODEL:-llama3.2:3b}"
PRIMARY_MODEL="${OLLAMA_FAST_MODEL:-${OLLAMA_COMMENT_MODEL:-$BASE_MODEL}}"
QUALITY_MODEL="${OLLAMA_QUALITY_MODEL:-$PRIMARY_MODEL}"
COMMENT_QUALITY_MODEL="${OLLAMA_COMMENT_QUALITY_MODEL:-$QUALITY_MODEL}"
NUM_CTX="${OLLAMA_NUM_CTX:-2048}"

upsert_kv() {
  local key="$1"
  local value="$2"

  if grep -Eq "^${key}=" "$ENV_FILE"; then
    sed -i "s#^${key}=.*#${key}=${value}#g" "$ENV_FILE"
  else
    printf "%s=%s\n" "$key" "$value" >> "$ENV_FILE"
  fi
}

if [[ ! -f "$ENV_FILE" ]]; then
  if [[ -f "$EXAMPLE_FILE" ]]; then
    cp "$EXAMPLE_FILE" "$ENV_FILE"
    echo "Created $ENV_FILE from config/local_ai.env.example"
  else
    touch "$ENV_FILE"
    echo "Created empty $ENV_FILE"
  fi
fi

upsert_kv "OLLAMA_URL" "${OLLAMA_URL:-http://localhost:11434}"
upsert_kv "USE_LOCAL_AI_MICROSERVICE" "${USE_LOCAL_AI_MICROSERVICE:-true}"
upsert_kv "LOCAL_AI_MICROSERVICE_REQUIRED" "${LOCAL_AI_MICROSERVICE_REQUIRED:-false}"
upsert_kv "LOCAL_AI_ENABLE_VISION" "${LOCAL_AI_ENABLE_VISION:-true}"
upsert_kv "LOCAL_AI_ENABLE_VIDEO" "${LOCAL_AI_ENABLE_VIDEO:-true}"
upsert_kv "LOCAL_AI_ENABLE_FACE" "${LOCAL_AI_ENABLE_FACE:-true}"
upsert_kv "LOCAL_AI_ENABLE_OCR" "${LOCAL_AI_ENABLE_OCR:-true}"
upsert_kv "LOCAL_AI_ENABLE_WHISPER" "${LOCAL_AI_ENABLE_WHISPER:-true}"
upsert_kv "MICROSERVICE_SAFE_MODE_FALLBACK" "${MICROSERVICE_SAFE_MODE_FALLBACK:-true}"
upsert_kv "MICROSERVICE_FORCE_SAFE_MODE" "${MICROSERVICE_FORCE_SAFE_MODE:-false}"
upsert_kv "OLLAMA_MODEL" "$BASE_MODEL"
upsert_kv "OLLAMA_FAST_MODEL" "$PRIMARY_MODEL"
upsert_kv "OLLAMA_QUALITY_MODEL" "$QUALITY_MODEL"
upsert_kv "OLLAMA_COMMENT_QUALITY_MODEL" "$COMMENT_QUALITY_MODEL"
upsert_kv "OLLAMA_VISION_MODEL" "$VISION_MODEL"
upsert_kv "OLLAMA_COMMENT_MODEL" "$PRIMARY_MODEL"
upsert_kv "OLLAMA_VISION_UNDERSTANDING_ENABLED" "${OLLAMA_VISION_UNDERSTANDING_ENABLED:-true}"
upsert_kv "OLLAMA_VISION_MAX_IMAGES" "${OLLAMA_VISION_MAX_IMAGES:-2}"
upsert_kv "OLLAMA_NUM_CTX" "$NUM_CTX"
upsert_kv "LOCAL_PROVIDER_LIGHTWEIGHT_MODE" "${LOCAL_PROVIDER_LIGHTWEIGHT_MODE:-true}"
upsert_kv "LOCAL_PROVIDER_MIN_LOCAL_SIGNALS_FOR_VISION_SKIP" "${LOCAL_PROVIDER_MIN_LOCAL_SIGNALS_FOR_VISION_SKIP:-3}"
upsert_kv "LOCAL_PROVIDER_DYNAMIC_KEYFRAME_LIMIT" "${LOCAL_PROVIDER_DYNAMIC_KEYFRAME_LIMIT:-2}"

upsert_kv "POST_VIDEO_LIGHTWEIGHT_MODE" "${POST_VIDEO_LIGHTWEIGHT_MODE:-true}"
upsert_kv "POST_VIDEO_VISION_FRAME_SAMPLE_LIMIT" "${POST_VIDEO_VISION_FRAME_SAMPLE_LIMIT:-2}"
upsert_kv "POST_VIDEO_DYNAMIC_KEYFRAME_LIMIT" "${POST_VIDEO_DYNAMIC_KEYFRAME_LIMIT:-2}"
upsert_kv "POST_VIDEO_DYNAMIC_FRAME_INTERVAL_SECONDS" "${POST_VIDEO_DYNAMIC_FRAME_INTERVAL_SECONDS:-4.0}"
upsert_kv "POST_VIDEO_AUDIO_PRIORITY_MIN_WORDS" "${POST_VIDEO_AUDIO_PRIORITY_MIN_WORDS:-10}"
upsert_kv "POST_VIDEO_MIN_STRUCTURED_SIGNALS_FOR_SKIP" "${POST_VIDEO_MIN_STRUCTURED_SIGNALS_FOR_SKIP:-3}"
upsert_kv "POST_VIDEO_SKIP_DYNAMIC_VISION_WHEN_AUDIO_PRESENT" "${POST_VIDEO_SKIP_DYNAMIC_VISION_WHEN_AUDIO_PRESENT:-true}"
upsert_kv "POST_VIDEO_EXTRACTION_PROFILE" "${POST_VIDEO_EXTRACTION_PROFILE:-lightweight_v1}"

upsert_kv "LOCAL_AI_VIDEO_SAMPLE_RATE_SECONDS" "${LOCAL_AI_VIDEO_SAMPLE_RATE_SECONDS:-3}"
upsert_kv "LOCAL_AI_VIDEO_MAX_FRAMES" "${LOCAL_AI_VIDEO_MAX_FRAMES:-12}"
upsert_kv "LOCAL_AI_VIDEO_RESIZE_MAX_WIDTH" "${LOCAL_AI_VIDEO_RESIZE_MAX_WIDTH:-960}"
upsert_kv "LOCAL_AI_VIDEO_STATIC_PREFILTER" "${LOCAL_AI_VIDEO_STATIC_PREFILTER:-true}"
upsert_kv "LOCAL_AI_VIDEO_FRAME_CACHE_SIZE" "${LOCAL_AI_VIDEO_FRAME_CACHE_SIZE:-64}"
upsert_kv "LOCAL_AI_ENABLE_PADDLE_OCR" "${LOCAL_AI_ENABLE_PADDLE_OCR:-true}"
upsert_kv "LOCAL_AI_ENABLE_EASY_OCR" "${LOCAL_AI_ENABLE_EASY_OCR:-false}"
upsert_kv "LOCAL_WHISPER_MODEL" "${LOCAL_WHISPER_MODEL:-tiny}"
upsert_kv "LOCAL_WHISPER_COMPUTE_TYPE" "${LOCAL_WHISPER_COMPUTE_TYPE:-int8}"
upsert_kv "LOCAL_WHISPER_ALLOW_DYNAMIC_MODEL_LOADING" "${LOCAL_WHISPER_ALLOW_DYNAMIC_MODEL_LOADING:-false}"

upsert_kv "LLM_COMMENT_ENABLE_MODEL_ESCALATION" "${LLM_COMMENT_ENABLE_MODEL_ESCALATION:-false}"
upsert_kv "LLM_COMMENT_ESCALATION_MIN_ACCEPTED" "${LLM_COMMENT_ESCALATION_MIN_ACCEPTED:-5}"
upsert_kv "LLM_COMMENT_ESCALATION_MAX_REJECT_RATIO" "${LLM_COMMENT_ESCALATION_MAX_REJECT_RATIO:-0.45}"
upsert_kv "LLM_COMMENT_ESCALATION_MIN_GROUNDED_RATIO" "${LLM_COMMENT_ESCALATION_MIN_GROUNDED_RATIO:-0.55}"
upsert_kv "LLM_COMMENT_MAX_CONTEXT_JSON_CHARS" "${LLM_COMMENT_MAX_CONTEXT_JSON_CHARS:-2200}"
upsert_kv "LLM_COMMENT_TARGET_CONTEXT_JSON_CHARS" "${LLM_COMMENT_TARGET_CONTEXT_JSON_CHARS:-1600}"
upsert_kv "LLM_COMMENT_PRIMARY_MAX_TOKENS" "${LLM_COMMENT_PRIMARY_MAX_TOKENS:-140}"
upsert_kv "LLM_COMMENT_PRIMARY_RETRY_MAX_TOKENS" "${LLM_COMMENT_PRIMARY_RETRY_MAX_TOKENS:-110}"
upsert_kv "LLM_COMMENT_QUALITY_MAX_TOKENS" "${LLM_COMMENT_QUALITY_MAX_TOKENS:-190}"
upsert_kv "LLM_COMMENT_QUALITY_RETRY_MAX_TOKENS" "${LLM_COMMENT_QUALITY_RETRY_MAX_TOKENS:-140}"

echo "Configured local AI env values in $ENV_FILE"
echo "  OLLAMA_VISION_MODEL=$VISION_MODEL"
echo "  OLLAMA_FAST_MODEL=$PRIMARY_MODEL"
echo "  OLLAMA_QUALITY_MODEL=$QUALITY_MODEL"
echo "  OLLAMA_NUM_CTX=$NUM_CTX"
