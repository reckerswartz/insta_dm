#!/bin/bash

# Local AI Services Diagnostic Script

echo "ðŸ” Local AI Services Diagnostic"
echo "=============================="

# Check Python environment
echo "ðŸ Python Environment:"
if command -v python3 &> /dev/null; then
    echo "âœ… Python3 available: $(python3 --version)"
else
    echo "âŒ Python3 not found"
    exit 1
fi

# Check virtual environment
echo ""
echo "ðŸ“¦ Virtual Environment:"
if [ -d "ai_microservice/ai_microservice_env" ]; then
    echo "âœ… Virtual environment exists"
    
    # Check if key packages are installed
    echo "ðŸ“š Checking packages..."
    source ai_microservice/ai_microservice_env/bin/activate
    
    packages=("fastapi" "uvicorn" "numpy" "pillow")
    for package in "${packages[@]}"; do
        if python -c "import $package" 2>/dev/null; then
            echo "âœ… $package installed"
        else
            echo "âŒ $package missing"
        fi
    done
    
    deactivate
else
    echo "âŒ Virtual environment not found"
    echo "ðŸ’¡ Run: cd ai_microservice && ./setup.sh"
fi

# Check services
echo ""
echo "ðŸ”— Service Connectivity:"
if curl -s http://localhost:8000/health > /dev/null 2>&1; then
    echo "âœ… AI Microservice responding on port 8000"
else
    echo "âŒ AI Microservice not responding on port 8000"
fi

if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
    echo "âœ… Ollama responding on port 11434"
else
    echo "âŒ Ollama not responding on port 11434"
fi

# Check directories
echo ""
echo "ðŸ“ Directory Structure:"
dirs=("tmp" "log" "ai_microservice/services")
for dir in "${dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo "âœ… $dir/ exists"
    else
        echo "âŒ $dir/ missing"
    fi
done

# Check files
echo ""
echo "ðŸ“„ Key Files:"
files=("ai_microservice/main.py" "ai_microservice/main_simple.py" "ai_microservice/test_setup.py")
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        echo "âœ… $file exists"
    else
        echo "âŒ $file missing"
    fi
done

# Check logs
echo ""
echo "ðŸ“‹ Recent Logs:"
if [ -f "log/ai_microservice.log" ]; then
    echo "ðŸ“„ AI Microservice log (last 10 lines):"
    tail -n 10 log/ai_microservice.log 2>/dev/null || echo "Log file empty"
else
    echo "âŒ No AI Microservice log found"
fi

# Check processes
echo ""
echo "âš™ï¸ Running Processes:"
if pgrep -f "python.*main.py" > /dev/null; then
    echo "âœ… AI Microservice process running (PID: $(pgrep -f 'python.*main.py'))"
else
    echo "âŒ AI Microservice process not found"
fi

if pgrep ollama > /dev/null; then
    echo "âœ… Ollama process running (PID: $(pgrep ollama))"
else
    echo "âŒ Ollama process not found"
fi

# Test basic functionality
echo ""
echo "ðŸ§ª Quick Tests:"
echo "Testing AI Microservice health endpoint..."
if curl -s http://localhost:8000/health | python -m json.tool 2>/dev/null; then
    echo "âœ… Health endpoint working"
else
    echo "âŒ Health endpoint failed"
fi

echo ""
echo "Testing Ollama API..."
if curl -s http://localhost:11434/api/tags | python -m json.tool 2>/dev/null; then
    echo "âœ… Ollama API working"
else
    echo "âŒ Ollama API failed"
fi

echo ""
echo "ðŸŽ¯ Recommendations:"
if ! curl -s http://localhost:8000/health > /dev/null; then
    echo "ðŸ’¡ Start AI Microservice: ./bin/local_ai_services start"
fi

if ! curl -s http://localhost:11434/api/tags > /dev/null; then
    echo "ðŸ’¡ Start Ollama: sudo systemctl start ollama"
fi

if [ ! -d "ai_microservice/ai_microservice_env" ]; then
    echo "ðŸ’¡ Setup Python environment: cd ai_microservice && ./setup.sh"
fi

echo ""
echo "ðŸ”§ For detailed logs: ./bin/local_ai_services logs"
