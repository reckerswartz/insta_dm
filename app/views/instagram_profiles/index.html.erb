<% content_for :title, "Instagram Profiles" %>

<%= turbo_stream_from @account %>

<div class="page">
  <header class="page-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div>
        <h1>Profiles</h1>
        <p class="meta">
          Browse profiles for <strong><%= @account.username %></strong>. Manage authentication and account-level tools on the
          <%= link_to "account dashboard", instagram_account_path(@account), class: "link-inline" %>.
        </p>
      </div>
      <%= link_to "Account Dashboard", instagram_account_path(@account), class: "btn secondary" %>
    </div>
  </header>

  <section class="card">
    <h2>Sync</h2>
    <p>Primary source is your Followers + Following lists (not inbox/stories). Sync runs in the background and will notify here when complete.</p>

    <div class="actions-row">
      <%= button_to "Sync Followers/Following (Background)", follow_graph_sync_path, method: :post %>
      <%= button_to "Download Missing Avatars (Background)", download_missing_avatars_instagram_profiles_path, method: :post, class: "btn secondary" %>
    </div>

    <div id="sync_status">
      <%= render "sync_runs/status", sync_run: @latest_sync_run %>
    </div>

    <p class="meta">
      Profiles: <strong><%= @counts[:total] %></strong>
      | Followers: <strong><%= @counts[:followers] %></strong>
      | Following: <strong><%= @counts[:following] %></strong>
      | Mutuals: <strong><%= @counts[:mutuals] %></strong>
    </p>
  </section>

  <section class="card">
    <h2>Profiles Data Table</h2>
    <p class="meta">Use header filters/sorting. Shift + wheel scrolls horizontally, and click-drag pans vertically/horizontally.</p>

    <div class="tabulator-shell" data-controller="profiles-table" data-profiles-table-url-value="<%= instagram_profiles_path(format: :json) %>">
      <div class="tabulator-host" data-profiles-table-target="table"></div>
    </div>
  </section>
</div>
