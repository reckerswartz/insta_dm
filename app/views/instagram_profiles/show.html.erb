<% content_for :title, @profile.username %>
<% history_state = @history_build_state.is_a?(Hash) ? @history_build_state : {} %>
<% history_checks = history_state["checks"].is_a?(Hash) ? history_state["checks"] : {} %>
<% history_queue = history_state["queue"].is_a?(Hash) ? history_state["queue"] : {} %>
<% history_face = history_state["face_verification"].is_a?(Hash) ? history_state["face_verification"] : {} %>
<% history_conversation = history_state["conversation"].is_a?(Hash) ? history_state["conversation"] : {} %>
<% history_status_label =
  if ActiveModel::Type::Boolean.new.cast(history_state["ready"])
    "History Ready"
  elsif history_state["status"].to_s == "blocked"
    "Blocked"
  elsif history_state["status"].to_s == "pending" || history_state["status"].to_s == "running"
    "Building"
  else
    "Not started"
  end %>
<% profile_instagram_url = "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{@profile.username}/" %>
<% profile_avatar_url =
  if @profile.avatar.attached?
    url_for(@profile.avatar)
  elsif @profile.profile_pic_url.present?
    @profile.profile_pic_url
  else
    asset_path("default_avatar.svg")
  end %>
<% profile_avatar_download_url =
  if @profile.avatar.attached?
    rails_blob_path(@profile.avatar, disposition: "attachment")
  elsif @profile.profile_pic_url.present?
    @profile.profile_pic_url
  end %>

<div
  class="page profile-page"
  data-controller="profile-sections-loader"
  data-profile-sections-loader-retry-limit-value="3"
  data-profile-sections-loader-poll-ms-value="900"
  data-profile-sections-loader-max-wait-ms-value="18000"
  data-profile-sections-loader-account-id-value="<%= @account.id %>"
  data-profile-sections-loader-profile-id-value="<%= @profile.id %>"
>
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1><%= @profile.username %></h1>
      <ul class="profile-status-list" aria-label="Profile status summary">
        <li class="profile-status-chip">
          Following
          <strong><%= @profile.following ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Follows you
          <strong><%= @profile.follows_you ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Mutual
          <strong><%= @profile.mutual? ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Can message
          <strong><%= @profile.can_message.nil? ? "Unknown" : (@profile.can_message ? "Yes" : "No") %></strong>
        </li>
        <li class="profile-status-chip">
          Last active
          <strong><%= relative_time_with_tooltip(@profile.last_active_at) %></strong>
        </li>
        <li class="profile-status-chip">
          History
          <strong><%= history_status_label %></strong>
        </li>
      </ul>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Back to Profiles", instagram_profiles_path, class: "btn secondary" %>
      <%= link_to "Account Dashboard", instagram_account_path(@account), class: "btn secondary" %>
    </div>
  </header>

  <nav class="profile-quick-links" aria-label="Profile sections">
    <a class="profile-quick-link" href="#profile_overview">Overview</a>
    <a class="profile-quick-link" href="#profile_details">Details</a>
    <a class="profile-quick-link" href="#profile_history_build">Build History</a>
    <a class="profile-quick-link" href="#profile_mutual">Mutual</a>
    <a class="profile-quick-link" href="#profile_ai_analysis">AI</a>
    <a class="profile-quick-link" href="#profile_captured_posts_drilldown">Posts</a>
    <a class="profile-quick-link" href="#profile_downloaded_stories_drilldown">Stories</a>
    <a class="profile-quick-link" href="#profile_messages_drilldown">Messages</a>
    <a class="profile-quick-link" href="#profile_actions_drilldown">Actions</a>
    <a class="profile-quick-link" href="#profile_events_table_drilldown">History</a>
  </nav>

  <section id="profile_overview" class="card">
    <h2>At a Glance</h2>
    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">Posts (Image Input)</div>
        <div class="stat-kv"><span class="muted">Captured total</span><strong><%= @profile_posts_total_count %></strong></div>
        <div class="stat-kv"><span class="muted">Active</span><strong><%= @active_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Deleted flagged</span><strong><%= @deleted_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">AI analyzed</span><strong><%= @analyzed_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Pending analysis</span><strong><%= @pending_posts_count %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Activity</div>
        <div class="stat-kv"><span class="muted">Messages</span><strong><%= @messages_count %></strong></div>
        <div class="stat-kv"><span class="muted">Action logs</span><strong><%= @action_logs_count %></strong></div>
        <div class="stat-kv"><span class="muted">Last analyzed</span><strong><%= relative_time_with_tooltip(@profile.ai_last_analyzed_at) %></strong></div>
        <div class="stat-kv"><span class="muted">Restriction</span><strong><%= @profile.restriction_reason.presence || "-" %></strong></div>
      </div>
    </div>
  </section>

  <section id="profile_details" class="card">
    <div class="profile-header">
      <% if @profile.avatar.attached? %>
        <%= image_tag @profile.avatar, class: "avatar large", alt: @profile.username %>
      <% elsif @profile.profile_pic_url.present? %>
        <img class="avatar large" src="<%= @profile.profile_pic_url %>" alt="<%= @profile.username %>">
      <% else %>
        <%= image_tag "default_avatar.svg", class: "avatar large", alt: @profile.username %>
      <% end %>

      <div class="profile-header-content">
        <h2 class="profile-title"><%= @profile.display_label %></h2>

        <div class="profile-meta-list">
          <p class="meta profile-meta-row">
            Instagram:
            <%= link_to "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{@profile.username}/", "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{@profile.username}/", target: "_blank", rel: "noreferrer" %>
          </p>
          <% if @profile.avatar.attached? %>
            <p class="meta profile-meta-row">
              Avatar:
              <%= link_to "download", rails_blob_path(@profile.avatar, disposition: "attachment"), class: "btn small secondary" %>
            </p>
          <% end %>
          <p class="meta profile-meta-row">
            Tags:
            <% if @profile.profile_tags.any? %>
              <strong><%= @profile.profile_tags.pluck(:name).sort.join(", ") %></strong>
            <% else %>
              <span class="muted">none</span>
            <% end %>
          </p>
        </div>

        <p class="meta profile-action-note">Actions below run as background jobs.</p>

        <div class="actions-row">
          <%= button_to "Capture Posts", capture_posts_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Fetch Details", fetch_details_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Verify Messageability", verify_messageability_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Sync Avatar", download_avatar_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
        </div>

        <details class="details-box profile-secondary-actions">
          <summary>Story analysis actions</summary>
          <div class="actions-row mt-2">
            <%= button_to "Analyze Stories (10)", sync_stories_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
            <%= button_to "Force Re-analyze Stories (10)",
                  sync_stories_force_instagram_profile_path(@profile),
                  method: :post,
                  class: "btn secondary",
                  form: {
                    data: {
                      confirm_modal: true,
                      confirm_title: "Force story re-analysis?",
                      confirm_message: "Re-run story analysis for up to 10 latest stories for this profile?"
                    }
                  } %>
          </div>
        </details>
      </div>
    </div>
  </section>

  <%= render "profile_tags_section", profile: @profile, available_tags: @available_tags %>

  <section id="profile_history_build" class="card">
    <h2>Build History</h2>
    <p class="meta">
      Verifies capture completeness, ensures latest posts are analyzed, re-checks face identity mapping, and sets <strong>History Ready</strong> only when all checks pass.
    </p>

    <div class="actions-row">
      <%= button_to "Build History", build_history_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
    </div>

    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">History Checks</div>
        <div class="stat-kv"><span class="muted">Status</span><strong><%= history_status_label %></strong></div>
        <div class="stat-kv"><span class="muted">All posts captured</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_checks.dig("all_posts_captured", "ready")) ? "Yes" : "No" %></strong></div>
        <div class="stat-kv"><span class="muted">Latest 50 captured</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_checks.dig("latest_50_captured", "ready")) ? "Yes" : "No" %></strong></div>
        <div class="stat-kv"><span class="muted">Recent 20 analyzed</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_checks.dig("latest_20_analyzed", "ready")) ? "Yes" : "No" %></strong></div>
        <div class="stat-kv"><span class="muted">Updated</span><strong><%= relative_time_with_tooltip(history_state["updated_at"]) %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Identity & Conversation</div>
        <div class="stat-kv"><span class="muted">Face identity confirmed</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_face["confirmed"]) ? "Yes" : "No" %></strong></div>
        <div class="stat-kv"><span class="muted">Detected faces</span><strong><%= history_face["total_faces"].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Reference matches</span><strong><%= history_face["reference_face_count"].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Can start conversation</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_conversation["can_generate_initial_message"]) ? "Yes" : "No" %></strong></div>
        <div class="stat-kv"><span class="muted">Can reply to messages</span><strong><%= ActiveModel::Type::Boolean.new.cast(history_conversation["can_respond_to_existing_messages"]) ? "Yes" : "No" %></strong></div>
      </div>
    </div>

    <% if history_state["reason"].to_s.present? %>
      <p class="meta profile-history-reason"><strong>Reason:</strong> <%= history_state["reason"] %></p>
    <% end %>

    <% if history_queue.present? %>
      <p class="meta profile-history-reason">
        Queue: downloads queued <strong><%= history_queue["downloads_queued"].to_i %></strong>,
        downloads pending <strong><%= history_queue["downloads_pending"].to_i %></strong>,
        analyses queued <strong><%= history_queue["analyses_queued"].to_i %></strong>,
        analyses pending <strong><%= history_queue["analyses_pending"].to_i %></strong>.
      </p>
    <% end %>

    <% if Array(history_conversation["suggested_openers"]).any? %>
      <p class="meta profile-history-reason">
        Suggested initial messages:
        <strong><%= Array(history_conversation["suggested_openers"]).first(3).join(" | ") %></strong>
      </p>
    <% end %>
  </section>

  <section id="profile_mutual" class="card">
    <h2>Mutual</h2>
    <div class="mutual-primary-profile">
      <button
        type="button"
        class="mutual-avatar-button"
        data-bs-toggle="modal"
        data-bs-target="#profileMutualAvatarModal"
        aria-label="Open avatar preview"
      >
        <img class="avatar large" src="<%= profile_avatar_url %>" alt="<%= @profile.username %> avatar">
      </button>
      <div class="mutual-primary-meta">
        <%= link_to "@#{@profile.username}", profile_instagram_url, target: "_blank", rel: "noopener noreferrer", class: "mutual-username-link" %>
        <p class="meta">Click name to open Instagram profile. Click avatar to preview and download.</p>
      </div>
    </div>

    <h3 class="mutual-row-title">Mutual Friends</h3>
    <% if @mutual_profiles.any? %>
      <div class="mutual-friends-row">
        <% @mutual_profiles.each do |mutual_profile| %>
          <% mutual_instagram_url = "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{mutual_profile.username}/" %>
          <article class="mutual-friend-card">
            <% if mutual_profile.avatar.attached? %>
              <%= image_tag mutual_profile.avatar, class: "avatar", alt: mutual_profile.username %>
            <% elsif mutual_profile.profile_pic_url.present? %>
              <img class="avatar" src="<%= mutual_profile.profile_pic_url %>" alt="<%= mutual_profile.username %>">
            <% else %>
              <%= image_tag "default_avatar.svg", class: "avatar", alt: mutual_profile.username %>
            <% end %>
            <%= link_to "@#{mutual_profile.username}", mutual_instagram_url, target: "_blank", rel: "noopener noreferrer", class: "mutual-friend-name" %>
          </article>
        <% end %>
      </div>
    <% else %>
      <p class="meta">No additional mutual profiles found.</p>
    <% end %>
  </section>

  <div class="modal fade app-media-modal" id="profileMutualAvatarModal" tabindex="-1" aria-labelledby="profileMutualAvatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileMutualAvatarModalLabel">Avatar Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img class="modal-media-image img-fluid rounded" src="<%= profile_avatar_url %>" alt="<%= @profile.username %> avatar">
          <p class="meta mt-2 mb-0"><%= @profile.username %></p>
        </div>
        <div class="modal-footer">
          <% if profile_avatar_download_url.present? %>
            <%= link_to "Download", profile_avatar_download_url, class: "btn secondary", target: "_blank", rel: "noreferrer" %>
          <% end %>
          <button type="button" class="btn secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <section id="profile_message_form" class="card">
    <h2>Send Message</h2>
    <div id="message_form">
      <%= render "instagram_messages/form", profile: @profile, message: @new_message %>
    </div>
  </section>

  <section id="profile_ai_analysis" class="card">
    <h2>AI Profile Analysis</h2>
    <p class="meta">
      Generates an AI summary from locally captured profile details, image posts, and comments. Demographic values are stored as AI estimates with confidence.
    </p>

    <div class="actions-row">
      <%= button_to "Analyze Profile", analyze_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
    </div>

    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">Demographic Estimates</div>
        <div class="stat-kv"><span class="muted">Age</span><strong><%= @profile.ai_estimated_age.presence || "-" %></strong></div>
        <div class="stat-kv"><span class="muted">Gender</span><strong><%= @profile.ai_estimated_gender.presence || "-" %></strong></div>
        <div class="stat-kv"><span class="muted">Location</span><strong><%= @profile.ai_estimated_location.presence || "-" %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Analysis Status</div>
        <div class="stat-kv"><span class="muted">Last analyzed</span><strong><%= relative_time_with_tooltip(@profile.ai_last_analyzed_at) %></strong></div>
        <div class="stat-kv"><span class="muted">Analyzed posts</span><strong><%= @analyzed_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Needs analysis</span><strong><%= @pending_posts_count %></strong></div>
      </div>
    </div>

    <% if @latest_analysis.present? && @latest_analysis.status == "succeeded" %>
      <p class="meta">
        Last analysis: <strong><%= relative_time_with_tooltip(@latest_analysis.created_at) %></strong>
        <% if @latest_analysis.provider.present? %>
          | Provider: <strong><%= @latest_analysis.provider %></strong>
        <% end %>
        <% if @latest_analysis.model.present? %>
          | Model: <strong><%= @latest_analysis.model %></strong>
        <% end %>
      </p>

      <details class="details-box">
        <summary>Show Full Analysis JSON</summary>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(@latest_analysis.analysis || {}) rescue (@latest_analysis.analysis || {}).to_json %></pre>
        </div>
      </details>
    <% elsif @latest_analysis.present? && @latest_analysis.status == "failed" %>
      <p class="meta">Last analysis failed: <strong><%= @latest_analysis.error_message %></strong></p>
    <% else %>
      <p class="meta">No AI analysis saved yet.</p>
    <% end %>

    <% if @latest_story_intelligence_event.present? %>
      <% intel_meta = @latest_story_intelligence_event.metadata.is_a?(Hash) ? @latest_story_intelligence_event.metadata : {} %>
      <% intel = intel_meta["local_story_intelligence"].is_a?(Hash) ? intel_meta["local_story_intelligence"] : {} %>
      <% snapshot = {
        event_id: @latest_story_intelligence_event.id,
        occurred_at: @latest_story_intelligence_event.occurred_at || @latest_story_intelligence_event.detected_at,
        source: intel["source"],
        ocr_text: intel["ocr_text"] || intel_meta["ocr_text"],
        transcript: intel["transcript"] || intel_meta["transcript"],
        objects: intel["objects"] || intel_meta["content_signals"],
        scenes: intel["scenes"] || intel_meta["scenes"],
        object_detections: intel["object_detections"] || intel_meta["object_detections"],
        ocr_blocks: intel["ocr_blocks"] || intel_meta["ocr_blocks"],
        hashtags: intel["hashtags"] || intel_meta["hashtags"],
        mentions: intel["mentions"] || intel_meta["mentions"],
        face_count: intel["face_count"] || intel_meta["face_count"],
        people: intel["people"] || intel_meta["face_people"]
      } %>
      <details class="details-box">
        <summary>Show Latest Story Intelligence Snapshot</summary>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(snapshot) rescue snapshot.to_json %></pre>
        </div>
      </details>
    <% end %>
  </section>

  <details id="profile_captured_posts_drilldown" class="details-box profile-drilldown" open>
    <summary>Captured Profile Posts (AI Input)</summary>
    <div class="profile-drilldown-body">
      <%= turbo_frame_tag "profile_captured_posts_#{@profile.id}", src: captured_posts_section_instagram_profile_path(@profile), loading: :lazy do %>
        <p class="meta profile-frame-placeholder">Loading captured posts...</p>
      <% end %>
    </div>
  </details>

  <details id="profile_downloaded_stories_drilldown" class="details-box profile-drilldown">
    <summary>Downloaded Stories</summary>
    <div class="profile-drilldown-body">
      <%= turbo_frame_tag "profile_downloaded_stories_#{@profile.id}", src: downloaded_stories_section_instagram_profile_path(@profile), loading: :lazy do %>
        <p class="meta profile-frame-placeholder">Loading downloaded stories...</p>
      <% end %>
    </div>
  </details>

  <details id="profile_messages_drilldown" class="details-box profile-drilldown">
    <summary>Message History (<%= @messages_count %>)</summary>
    <div class="profile-drilldown-body">
      <%= turbo_frame_tag "profile_messages_#{@profile.id}", src: messages_section_instagram_profile_path(@profile), loading: :lazy do %>
        <p class="meta profile-frame-placeholder">Loading message history...</p>
      <% end %>
    </div>
  </details>

  <details id="profile_actions_drilldown" class="details-box profile-drilldown">
    <summary>Action History (<%= @action_logs_count %>)</summary>
    <div class="profile-drilldown-body">
      <%= turbo_frame_tag "profile_actions_#{@profile.id}", src: action_history_section_instagram_profile_path(@profile), loading: :lazy do %>
        <p class="meta profile-frame-placeholder">Loading action history...</p>
      <% end %>
    </div>
  </details>

  <details id="profile_events_table_drilldown" class="details-box profile-drilldown">
    <summary>Unified History</summary>
    <div class="profile-drilldown-body">
      <%= turbo_frame_tag "profile_events_table_#{@profile.id}", src: events_table_section_instagram_profile_path(@profile), loading: :lazy do %>
        <p class="meta profile-frame-placeholder">Loading profile history table...</p>
      <% end %>
    </div>
  </details>

</div>
