<% content_for :title, @profile.username %>

<div
  class="page profile-page"
  data-controller="profile-sections-loader"
  data-profile-sections-loader-retry-limit-value="3"
  data-profile-sections-loader-poll-ms-value="900"
  data-profile-sections-loader-max-wait-ms-value="18000"
  data-profile-sections-loader-account-id-value="<%= @account.id %>"
  data-profile-sections-loader-profile-id-value="<%= @profile.id %>"
>
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1><%= @profile.username %></h1>
      <ul class="profile-status-list" aria-label="Profile status summary">
        <li class="profile-status-chip">
          Following
          <strong><%= @profile.following ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Follows you
          <strong><%= @profile.follows_you ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Mutual
          <strong><%= @profile.mutual? ? "Yes" : "No" %></strong>
        </li>
        <li class="profile-status-chip">
          Can message
          <strong><%= @profile.can_message.nil? ? "Unknown" : (@profile.can_message ? "Yes" : "No") %></strong>
        </li>
        <li class="profile-status-chip">
          Last active
          <strong><%= relative_time_with_tooltip(@profile.last_active_at) %></strong>
        </li>
      </ul>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Back to Profiles", instagram_profiles_path, class: "btn secondary" %>
      <%= link_to "Account Dashboard", instagram_account_path(@account), class: "btn secondary" %>
    </div>
  </header>

  <nav class="profile-quick-links" aria-label="Profile sections">
    <a class="profile-quick-link" href="#profile_overview">Overview</a>
    <a class="profile-quick-link" href="#profile_details">Details</a>
    <a class="profile-quick-link" href="#profile_ai_analysis">AI</a>
    <a class="profile-quick-link" href="#profile_captured_posts_<%= @profile.id %>">Posts</a>
    <a class="profile-quick-link" href="#profile_downloaded_stories_<%= @profile.id %>">Stories</a>
    <a class="profile-quick-link" href="#profile_messages_<%= @profile.id %>">Messages</a>
    <a class="profile-quick-link" href="#profile_actions_<%= @profile.id %>">Actions</a>
    <a class="profile-quick-link" href="#profile_events_table_<%= @profile.id %>">History</a>
  </nav>

  <section id="profile_overview" class="card">
    <h2>At a Glance</h2>
    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">Posts (Image Input)</div>
        <div class="stat-kv"><span class="muted">Captured total</span><strong><%= @profile_posts_total_count %></strong></div>
        <div class="stat-kv"><span class="muted">Active</span><strong><%= @active_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Deleted flagged</span><strong><%= @deleted_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">AI analyzed</span><strong><%= @analyzed_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Pending analysis</span><strong><%= @pending_posts_count %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Activity</div>
        <div class="stat-kv"><span class="muted">Messages</span><strong><%= @messages_count %></strong></div>
        <div class="stat-kv"><span class="muted">Action logs</span><strong><%= @action_logs_count %></strong></div>
        <div class="stat-kv"><span class="muted">Last analyzed</span><strong><%= relative_time_with_tooltip(@profile.ai_last_analyzed_at) %></strong></div>
        <div class="stat-kv"><span class="muted">Restriction</span><strong><%= @profile.restriction_reason.presence || "-" %></strong></div>
      </div>
    </div>
  </section>

  <section id="profile_details" class="card">
    <div class="profile-header">
      <% if @profile.avatar.attached? %>
        <%= image_tag @profile.avatar, class: "avatar large", alt: @profile.username %>
      <% elsif @profile.profile_pic_url.present? %>
        <img class="avatar large" src="<%= @profile.profile_pic_url %>" alt="<%= @profile.username %>">
      <% else %>
        <%= image_tag "default_avatar.svg", class: "avatar large", alt: @profile.username %>
      <% end %>

      <div class="profile-header-content">
        <h2 class="profile-title"><%= @profile.display_label %></h2>

        <div class="profile-meta-list">
          <p class="meta profile-meta-row">
            Instagram:
            <%= link_to "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{@profile.username}/", "#{Instagram::Client::INSTAGRAM_BASE_URL}/#{@profile.username}/", target: "_blank", rel: "noreferrer" %>
          </p>
          <% if @profile.avatar.attached? %>
            <p class="meta profile-meta-row">
              Avatar:
              <%= link_to "download", rails_blob_path(@profile.avatar, disposition: "attachment"), class: "btn small secondary" %>
            </p>
          <% end %>
          <p class="meta profile-meta-row">
            Tags:
            <% if @profile.profile_tags.any? %>
              <strong><%= @profile.profile_tags.pluck(:name).sort.join(", ") %></strong>
            <% else %>
              <span class="muted">none</span>
            <% end %>
          </p>
        </div>

        <p class="meta profile-action-note">Actions below run as background jobs.</p>

        <div class="actions-row">
          <%= button_to "Capture Posts", capture_posts_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Fetch Details", fetch_details_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Verify Messageability", verify_messageability_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
          <%= button_to "Sync Avatar", download_avatar_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
        </div>

        <details class="details-box profile-secondary-actions">
          <summary>Story analysis actions</summary>
          <div class="actions-row mt-2">
            <%= button_to "Analyze Stories (10)", sync_stories_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
            <%= button_to "Force Re-analyze Stories (10)",
                  sync_stories_force_instagram_profile_path(@profile),
                  method: :post,
                  class: "btn secondary",
                  form: {
                    data: {
                      confirm_modal: true,
                      confirm_title: "Force story re-analysis?",
                      confirm_message: "Re-run story analysis for up to 10 latest stories for this profile?"
                    }
                  } %>
          </div>
        </details>
      </div>
    </div>
  </section>

  <%= render "profile_tags_section", profile: @profile, available_tags: @available_tags %>

  <section id="profile_message_form" class="card">
    <h2>Send Message</h2>
    <div id="message_form">
      <%= render "instagram_messages/form", profile: @profile, message: @new_message %>
    </div>
  </section>

  <section id="profile_ai_analysis" class="card">
    <h2>AI Profile Analysis</h2>
    <p class="meta">
      Generates an AI summary from locally captured profile details, image posts, and comments. Demographic values are stored as AI estimates with confidence.
    </p>

    <div class="actions-row">
      <%= button_to "Analyze Profile", analyze_instagram_profile_path(@profile), method: :post, class: "btn secondary" %>
    </div>

    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">Demographic Estimates</div>
        <div class="stat-kv"><span class="muted">Age</span><strong><%= @profile.ai_estimated_age.presence || "-" %></strong></div>
        <div class="stat-kv"><span class="muted">Gender</span><strong><%= @profile.ai_estimated_gender.presence || "-" %></strong></div>
        <div class="stat-kv"><span class="muted">Location</span><strong><%= @profile.ai_estimated_location.presence || "-" %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Analysis Status</div>
        <div class="stat-kv"><span class="muted">Last analyzed</span><strong><%= relative_time_with_tooltip(@profile.ai_last_analyzed_at) %></strong></div>
        <div class="stat-kv"><span class="muted">Analyzed posts</span><strong><%= @analyzed_posts_count %></strong></div>
        <div class="stat-kv"><span class="muted">Needs analysis</span><strong><%= @pending_posts_count %></strong></div>
      </div>
    </div>

    <% if @latest_analysis.present? && @latest_analysis.status == "succeeded" %>
      <p class="meta">
        Last analysis: <strong><%= relative_time_with_tooltip(@latest_analysis.created_at) %></strong>
        <% if @latest_analysis.provider.present? %>
          | Provider: <strong><%= @latest_analysis.provider %></strong>
        <% end %>
        <% if @latest_analysis.model.present? %>
          | Model: <strong><%= @latest_analysis.model %></strong>
        <% end %>
      </p>

      <details class="details-box">
        <summary>Show Full Analysis JSON</summary>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(@latest_analysis.analysis || {}) rescue (@latest_analysis.analysis || {}).to_json %></pre>
        </div>
      </details>
    <% elsif @latest_analysis.present? && @latest_analysis.status == "failed" %>
      <p class="meta">Last analysis failed: <strong><%= @latest_analysis.error_message %></strong></p>
    <% else %>
      <p class="meta">No AI analysis saved yet.</p>
    <% end %>

    <% if @latest_story_intelligence_event.present? %>
      <% intel_meta = @latest_story_intelligence_event.metadata.is_a?(Hash) ? @latest_story_intelligence_event.metadata : {} %>
      <% intel = intel_meta["local_story_intelligence"].is_a?(Hash) ? intel_meta["local_story_intelligence"] : {} %>
      <% snapshot = {
        event_id: @latest_story_intelligence_event.id,
        occurred_at: @latest_story_intelligence_event.occurred_at || @latest_story_intelligence_event.detected_at,
        source: intel["source"],
        ocr_text: intel["ocr_text"] || intel_meta["ocr_text"],
        transcript: intel["transcript"] || intel_meta["transcript"],
        objects: intel["objects"] || intel_meta["content_signals"],
        scenes: intel["scenes"] || intel_meta["scenes"],
        object_detections: intel["object_detections"] || intel_meta["object_detections"],
        ocr_blocks: intel["ocr_blocks"] || intel_meta["ocr_blocks"],
        hashtags: intel["hashtags"] || intel_meta["hashtags"],
        mentions: intel["mentions"] || intel_meta["mentions"],
        face_count: intel["face_count"] || intel_meta["face_count"],
        people: intel["people"] || intel_meta["face_people"]
      } %>
      <details class="details-box">
        <summary>Show Latest Story Intelligence Snapshot</summary>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(snapshot) rescue snapshot.to_json %></pre>
        </div>
      </details>
    <% end %>
  </section>

  <%= turbo_frame_tag "profile_captured_posts_#{@profile.id}", src: captured_posts_section_instagram_profile_path(@profile), loading: :eager do %>
    <section class="card">
      <h2>Captured Profile Posts (AI Input)</h2>
      <p class="meta">Loading captured posts...</p>
    </section>
  <% end %>

  <%= turbo_frame_tag "profile_downloaded_stories_#{@profile.id}", src: downloaded_stories_section_instagram_profile_path(@profile), loading: :eager do %>
    <section class="card">
      <h2>Downloaded Stories</h2>
      <p class="meta">Loading downloaded stories...</p>
    </section>
  <% end %>

  <%= turbo_frame_tag "profile_messages_#{@profile.id}", src: messages_section_instagram_profile_path(@profile), loading: :eager do %>
    <section class="card">
      <h2>Message History</h2>
      <p class="meta">Loading message history...</p>
    </section>
  <% end %>

  <%= turbo_frame_tag "profile_actions_#{@profile.id}", src: action_history_section_instagram_profile_path(@profile), loading: :eager do %>
    <section class="card">
      <h2>Action History</h2>
      <p class="meta">Loading action history...</p>
    </section>
  <% end %>

  <%= turbo_frame_tag "profile_events_table_#{@profile.id}", src: events_table_section_instagram_profile_path(@profile), loading: :eager do %>
    <section class="card">
      <h2>History</h2>
      <p class="meta">Loading profile history table...</p>
    </section>
  <% end %>

</div>
