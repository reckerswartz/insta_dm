<% story_profile = local_assigns[:profile] %>
<% profile_avatar_url =
  if story_profile&.avatar&.attached?
    rails_blob_path(story_profile.avatar, only_path: true)
  else
    story_profile&.profile_pic_url.to_s.presence
  end %>

<section class="card">
  <h2>Downloaded Stories</h2>
  <p class="meta">Archive-style story cards for this profile. Duplicate downloads are avoided and previously captured media is reused.</p>

  <% if downloaded_story_events.any? %>
    <div class="story-media-grid profile-story-grid">
      <% downloaded_story_events.each do |event| %>
        <% blob = event.media.blob %>
        <% content_type = blob&.content_type.to_s %>
        <% is_video = content_type.start_with?("video/") %>
        <% view_url = rails_blob_path(event.media, only_path: true) %>
        <% download_url = rails_blob_path(event.media, only_path: true, disposition: "attachment") %>
        <% occurred = event.occurred_at || event.detected_at || event.created_at %>
        <% meta = event.metadata.is_a?(Hash) ? event.metadata : {} %>
        <% intel = meta["local_story_intelligence"].is_a?(Hash) ? meta["local_story_intelligence"] : {} %>
        <% objects = Array(intel["objects"] || meta["content_signals"]).map(&:to_s).reject(&:blank?).first(4) %>
        <% hashtags = Array(intel["hashtags"] || meta["hashtags"]).map(&:to_s).reject(&:blank?).first(4) %>
        <% mentions = Array(intel["mentions"] || meta["mentions"]).map(&:to_s).reject(&:blank?).first(4) %>
        <% face_count = (intel["face_count"] || meta["face_count"]).to_i %>
        <% skipped = ActiveModel::Type::Boolean.new.cast(meta["skipped"]) %>
        <% skip_reason = meta["skip_reason"].to_s.presence %>
        <% story_link = meta["permalink"].to_s.presence || "#{Instagram::Client::INSTAGRAM_BASE_URL}/stories/#{story_profile&.username}/" %>
        <% processing_meta = meta["processing_metadata"].is_a?(Hash) ? meta["processing_metadata"] : {} %>
        <% frame_change = processing_meta["frame_change_detection"].is_a?(Hash) ? processing_meta["frame_change_detection"] : {} %>
        <% local_intel = meta["local_story_intelligence"].is_a?(Hash) ? meta["local_story_intelligence"] : {} %>
        <% static_video = is_video && (
          processing_meta["source"].to_s == "video_static_single_frame" ||
          frame_change["processing_mode"].to_s == "static_image" ||
          local_intel["video_processing_mode"].to_s == "static_image"
        ) %>
        <% poster_url = begin
          direct =
            if event.preview_image.attached?
              rails_blob_path(event.preview_image, only_path: true)
            else
              meta["image_url"].to_s.presence
            end
          if direct.present?
            direct
          else
            variants = Array(meta["carousel_media"])
            candidate = variants.find { |entry| entry.is_a?(Hash) && entry["image_url"].to_s.present? }
            candidate.is_a?(Hash) ? candidate["image_url"].to_s.presence : nil
          end
        rescue StandardError
          nil
        end %>
        <% if is_video && poster_url.blank? && event.media.attached? %>
          <% begin %>
            <% poster_url = url_for(event.media.preview(resize_to_limit: [640, 640]).processed) %>
          <% rescue StandardError %>
            <% poster_url = nil %>
          <% end %>
        <% end %>

        <article class="story-media-card">
          <div class="story-card-banner">
            <div class="story-card-user">
              <% if profile_avatar_url.present? %>
                <img class="story-card-avatar" src="<%= profile_avatar_url %>" alt="<%= story_profile&.username || 'profile' %> avatar" loading="lazy" />
              <% else %>
                <span class="story-card-avatar story-card-avatar-placeholder">?</span>
              <% end %>
              <div class="story-card-user-text">
                <strong><%= story_profile&.display_name.presence || story_profile&.username %></strong>
                <span class="meta">@<%= story_profile&.username || "unknown" %></span>
              </div>
            </div>
            <a class="story-open-instagram" href="<%= story_link %>" target="_blank" rel="noopener noreferrer" aria-label="Open story on Instagram">
              <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7Zm5 3.25A4.75 4.75 0 1 1 7.25 12 4.76 4.76 0 0 1 12 7.25Zm0 2A2.75 2.75 0 1 0 14.75 12 2.75 2.75 0 0 0 12 9.25ZM17.5 6.5a1.25 1.25 0 1 1-1.25 1.25A1.25 1.25 0 0 1 17.5 6.5Z"/>
              </svg>
            </a>
          </div>

          <% if is_video %>
            <div class="story-media-preview story-video-player-shell <%= static_video ? 'story-video-static-preview' : '' %>">
              <video
                controls
                preload="none"
                playsinline
                data-controller="video-player"
                data-video-source="<%= view_url %>"
                data-video-content-type="<%= content_type %>"
                data-video-player-load-on-play-value="true"
                data-video-player-static-value="<%= static_video %>"
                data-video-static="<%= static_video %>"
                <% if poster_url.present? %>
                  poster="<%= poster_url %>"
                  data-video-player-poster-url-value="<%= poster_url %>"
                  data-video-poster-url="<%= poster_url %>"
                <% end %>
              ></video>
            </div>
          <% else %>
            <a class="story-media-preview story-preview-button" href="<%= view_url %>" target="_blank" rel="noreferrer">
              <img loading="lazy" src="<%= view_url %>" alt="Story media for <%= story_profile&.username || 'profile' %>" />
            </a>
          <% end %>

          <div class="story-media-meta">
            <p class="meta"><strong><%= event.kind.to_s.humanize %></strong> | <%= relative_time_with_tooltip(occurred) %></p>
            <p class="meta">Type: <%= content_type.presence || "-" %></p>
            <% if static_video %>
              <p class="meta">Static visual video detected: image-first preview enabled.</p>
            <% end %>
            <% if objects.any? || hashtags.any? || mentions.any? || face_count.positive? %>
              <p class="meta">Analysis: <%= objects.any? ? "objects=#{objects.join(', ')}" : nil %><%= objects.any? && (hashtags.any? || mentions.any? || face_count.positive?) ? " | " : "" %><%= hashtags.any? ? "hashtags=#{hashtags.join(', ')}" : nil %><%= hashtags.any? && (mentions.any? || face_count.positive?) ? " | " : "" %><%= mentions.any? ? "mentions=#{mentions.join(', ')}" : nil %><%= mentions.any? && face_count.positive? ? " | " : "" %><%= face_count.positive? ? "faces=#{face_count}" : nil %></p>
            <% end %>
            <% if skipped && skip_reason.present? %>
              <p class="meta story-skipped-badge">Skipped source story captured once: <%= skip_reason %></p>
            <% end %>
            <div class="actions-row">
              <a class="btn small" href="<%= view_url %>" target="_blank" rel="noreferrer">View</a>
              <a class="btn small secondary" href="<%= download_url %>" target="_blank" rel="noreferrer">Download</a>
            </div>
          </div>
        </article>
      <% end %>
    </div>
  <% else %>
    <p class="meta">No downloaded stories are available for this profile yet.</p>
  <% end %>
</section>
