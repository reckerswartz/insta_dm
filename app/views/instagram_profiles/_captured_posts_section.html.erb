<% visible_posts = profile_posts.first(20) %>
<% profile_avatar_url =
  if profile.avatar.attached?
    rails_blob_path(profile.avatar, only_path: true)
  else
    profile.profile_pic_url.to_s.presence
  end %>

<section id="captured_profile_posts_section" class="card">
  <h2>Captured Profile Posts (AI Input)</h2>
  <p class="meta">Archive-style view of captured posts. New items are downloaded once, deleted source posts are flagged (not removed), and duplicates are skipped.</p>

  <%# Analysis Controls %>
  <% total_posts = profile.instagram_profile_posts.count %>
  <% analyzed_posts = profile.instagram_profile_posts.where(ai_status: "analyzed").count %>
  <% unanalyzed_posts = total_posts - analyzed_posts %>

  <% if total_posts > 0 %>
    <div class="analysis-progress-panel">
      <p class="meta analysis-progress-summary">
        <strong>Analysis Status:</strong> 
        <%= analyzed_posts %> of <%= total_posts %> posts analyzed 
        (<%= unanalyzed_posts %> remaining)
      </p>

      <% if unanalyzed_posts > 0 %>
        <div class="analysis-progress-actions">
          <%= form_with url: analyze_next_batch_instagram_profile_instagram_profile_posts_path(profile), method: :post, local: true, class: "inline-form" do |form| %>
            <%= hidden_field_tag :offset, 50 %>
            <%= form.submit "Analyze posts 51-60", class: "btn small", disabled: unanalyzed_posts == 0 %>
          <% end %>

          <% if unanalyzed_posts > 10 %>
            <%= form_with url: analyze_next_batch_instagram_profile_instagram_profile_posts_path(profile), method: :post, local: true, class: "inline-form" do |form| %>
              <%= hidden_field_tag :offset, 60 %>
              <%= form.submit "Analyze posts 61-70", class: "btn small secondary" %>
            <% end %>
          <% end %>

          <% if unanalyzed_posts > 20 %>
            <%= form_with url: analyze_next_batch_instagram_profile_instagram_profile_posts_path(profile), method: :post, local: true, class: "inline-form" do |form| %>
              <%= hidden_field_tag :offset, 70 %>
              <%= form.submit "Analyze posts 71-80", class: "btn small secondary" %>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if visible_posts.any? %>
    <div data-controller="profile-post-modal">
      <div class="story-media-scroll profile-posts-scroll">
        <div class="story-media-grid profile-story-grid">
        <% visible_posts.each do |pp| %>
          <% comments = pp.instagram_profile_post_comments.recent_first.limit(12).map { |c| "#{c.author_username.presence || 'user'}: #{c.body}" } %>
          <% analysis = pp.analysis.is_a?(Hash) ? pp.analysis : {} %>
          <% metadata = pp.metadata.is_a?(Hash) ? pp.metadata : {} %>
          <% face_recognition = metadata["face_recognition"].is_a?(Hash) ? metadata["face_recognition"] : {} %>
          <% face_identity = metadata["face_identity"].is_a?(Hash) ? metadata["face_identity"] : {} %>
          <% face_participants = Array(face_identity["participants"]).select { |row| row.is_a?(Hash) } %>
          <% if face_participants.empty? %>
            <% face_participants = Array(face_recognition.dig("identity", "participants")).select { |row| row.is_a?(Hash) } %>
          <% end %>
          <% post_faces = pp.instagram_post_faces.to_a %>
          <% if face_participants.empty? && post_faces.any? %>
            <% face_participants = post_faces.first(12).map do |face|
              person = face.instagram_story_person
              {
                "person_id" => person&.id,
                "role" => face.role,
                "label" => person&.label,
                "appearances" => person&.appearance_count,
                "recurring_face" => person.present? && person.appearance_count.to_i > 1,
                "relationship" => person&.metadata_hash&.dig("relationship"),
                "co_appearances_with_primary" => person&.metadata_hash&.dig("co_appearances_with_primary"),
                "real_person_status" => person&.real_person_status,
                "identity_confidence" => person&.identity_confidence
              }.compact
            end %>
          <% end %>
          <% post_people_by_id = post_faces.map(&:instagram_story_person).compact.index_by(&:id) %>
          <% unique_people_count = post_faces.map(&:instagram_story_person_id).compact.uniq.count %>
          <% if unique_people_count <= 0 %>
            <% unique_people_count = face_participants.map { |row| row["person_id"].to_i }.reject(&:zero?).uniq.count %>
          <% end %>
          <% post_people_scope =
            if unique_people_count > 1
              "multiple_people"
            elsif unique_people_count == 1
              "single_person"
            end %>
          <% detected_face_count = face_recognition["face_count"].to_i %>
          <% detected_face_count = post_faces.length if detected_face_count <= 0 && post_faces.any? %>
          <% owner_faces_count = post_faces.count { |face| face.role.to_s == "primary_user" } %>
          <% recurring_faces_count = face_participants.count { |row| ActiveModel::Type::Boolean.new.cast(row["recurring_face"]) || row["appearances"].to_i > 1 } %>
          <% owner_faces_count = face_participants.count { |row| row["role"].to_s == "primary_user" } if owner_faces_count <= 0 && face_participants.any? %>
          <% face_summary_payload = {
            face_count: detected_face_count,
            owner_faces_count: owner_faces_count,
            recurring_faces_count: recurring_faces_count,
            detection_source: face_recognition["detection_source"].to_s.presence,
            participant_summary: face_recognition["participant_summary"].to_s.presence,
            post_people_scope: post_people_scope,
            unique_people_count: unique_people_count,
            participants: face_participants.first(12).map do |row|
              person_id = row["person_id"].to_i.positive? ? row["person_id"].to_i : nil
              person = person_id.present? ? post_people_by_id[person_id] : nil
              status = row["real_person_status"].to_s.presence || person&.real_person_status
              confidence = row["identity_confidence"]
              confidence = person&.identity_confidence if confidence.blank?
              confidence = confidence.to_f if confidence.present?
              {
                person_id: person_id,
                role: row["role"],
                label: row["label"],
                appearances: row["appearances"],
                recurring_face: row["recurring_face"],
                relationship: row["relationship"],
                co_appearances_with_primary: row["co_appearances_with_primary"],
                real_person_status: status,
                identity_confidence: confidence,
                person_path: person_id.present? ? instagram_profile_instagram_story_person_path(profile, person_id) : nil
              }.compact
            end
          } %>
          <% suggestions = Array(analysis["comment_suggestions"]) %>
          <% comment_gen_status = analysis["comment_generation_status"].to_s.presence || "unknown" %>
          <% comment_gen_source = analysis["comment_generation_source"].to_s.presence || "unknown" %>
          <% comment_gen_fallback = ActiveModel::Type::Boolean.new.cast(analysis["comment_generation_fallback_used"]) %>
          <% comment_gen_error = analysis["comment_generation_error"].to_s.presence %>
          <% image_url = pp.media.attached? ? rails_blob_path(pp.media, only_path: true) : nil %>
          <% download_url = pp.media.attached? ? rails_blob_path(pp.media, disposition: "attachment") : nil %>
          <% content_type = pp.media.attached? ? pp.media.blob.content_type.to_s : "" %>
          <% is_video = content_type.start_with?("video/") || metadata["media_type"].to_i == 2 %>
          <% poster_url =
            if pp.preview_image.attached?
              rails_blob_path(pp.preview_image, only_path: true)
            else
              metadata["preview_image_url"].to_s.presence ||
                metadata["poster_url"].to_s.presence ||
                metadata["image_url"].to_s.presence ||
                metadata["media_url_image"].to_s.presence
            end %>
          <% deleted_from_source = ActiveModel::Type::Boolean.new.cast(metadata["deleted_from_source"]) %>
          <% deleted_at = metadata["deleted_detected_at"].to_s.presence %>
          <% deleted_label =
            if deleted_at.present?
              begin
                Time.zone.parse(deleted_at).strftime("%Y-%m-%d %H:%M")
              rescue StandardError
                deleted_at
              end
            else
              "detected"
            end %>
          <% ig_url = pp.permalink_url %>

          <article class="story-media-card">
            <div class="story-card-banner">
              <div class="story-card-user">
                <% if profile_avatar_url.present? %>
                  <img class="story-card-avatar" src="<%= profile_avatar_url %>" alt="<%= profile.username %> avatar" loading="lazy" />
                <% else %>
                  <span class="story-card-avatar story-card-avatar-placeholder">?</span>
                <% end %>
                <div class="story-card-user-text">
                  <strong><%= profile.display_name.presence || profile.username %></strong>
                  <span class="meta">@<%= profile.username %></span>
                </div>
              </div>
              <a class="story-open-instagram" href="<%= ig_url %>" target="_blank" rel="noopener noreferrer" aria-label="Open post on Instagram">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5Zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7Zm5 3.25A4.75 4.75 0 1 1 7.25 12 4.76 4.76 0 0 1 12 7.25Zm0 2A2.75 2.75 0 1 0 14.75 12 2.75 2.75 0 0 0 12 9.25ZM17.5 6.5a1.25 1.25 0 1 1-1.25 1.25A1.25 1.25 0 0 1 17.5 6.5Z"/>
                </svg>
              </a>
            </div>

            <% if image_url.present? && !is_video %>
              <button
                type="button"
                class="story-media-preview story-preview-button"
                data-action="profile-post-modal#open"
                data-shortcode="<%= pp.shortcode %>"
                data-caption="<%= h(pp.caption.to_s) %>"
                data-likes="<%= pp.likes_count %>"
                data-comments-count="<%= pp.comments_count %>"
                data-taken-at="<%= pp.taken_at&.strftime('%Y-%m-%d %H:%M:%S') %>"
                data-image-url="<%= image_url %>"
                data-download-url="<%= download_url %>"
                data-permalink="<%= ig_url %>"
                data-media-content-type="<%= content_type %>"
                data-media-preview-image-url="<%= poster_url %>"
                data-video-static-frame-only="<%= metadata["video_static_frame_only"] %>"
                data-is-video="<%= is_video %>"
                data-ai-status="<%= pp.ai_status %>"
                data-ai-provider="<%= pp.ai_provider %>"
                data-ai-model="<%= pp.ai_model %>"
                data-comment-gen-status="<%= comment_gen_status %>"
                data-comment-gen-source="<%= comment_gen_source %>"
                data-comment-gen-fallback="<%= comment_gen_fallback %>"
                data-comment-gen-error="<%= h(comment_gen_error.to_s) %>"
                data-forward-url="<%= forward_comment_instagram_profile_instagram_profile_post_path(profile, pp) %>"
                data-comments-json="<%= h(comments.to_json) %>"
                data-suggestions-json="<%= h(suggestions.to_json) %>"
                data-face-summary-json="<%= h(face_summary_payload.to_json) %>"
              >
                <img loading="lazy" src="<%= image_url %>" alt="Captured post media for <%= profile.username %>" />
              </button>
            <% elsif image_url.present? && is_video %>
              <div class="story-media-preview story-video-player-shell">
                <video
                  controls
                  preload="none"
                  playsinline
                  data-controller="video-player"
                  data-video-source="<%= image_url %>"
                  data-video-content-type="<%= content_type %>"
                  data-video-player-autoplay-value="false"
                  data-video-player-load-on-play-value="true"
                  <% if poster_url.present? %>
                    poster="<%= poster_url %>"
                    data-video-player-poster-url-value="<%= poster_url %>"
                    data-video-poster-url="<%= poster_url %>"
                  <% end %>
                ></video>
              </div>
            <% else %>
              <div class="story-media-preview">
                <p class="meta">No image captured</p>
              </div>
            <% end %>

            <div class="story-media-meta">
              <p class="meta"><code><%= pp.shortcode %></code></p>
              <p class="meta"><%= pp.caption.to_s.truncate(110) %></p>
              <p class="meta">
                Taken: <%= relative_time_with_tooltip(pp.taken_at) %> |
                Likes: <%= pp.likes_count %> |
                Comments: <%= pp.comments_count %> |
                Type: <%= content_type.presence || "-" %>
              </p>
              <p class="meta">
                AI:
                <span class="pill <%= pp.ai_status == "failed" ? "failed" : (pp.ai_status == "analyzed" ? "sent" : "queued") %>"><%= pp.ai_status %></span>
                <% if comment_gen_fallback %>
                  | comments fallback (<%= comment_gen_status %>)
                <% elsif pp.ai_status == "analyzed" %>
                  | comments <%= comment_gen_source %> (<%= comment_gen_status %>)
                <% end %>
              </p>
              <% if detected_face_count.positive? || face_participants.any? %>
                <div class="post-face-summary">
                  <p class="meta">
                    Faces: <strong><%= detected_face_count %></strong>
                    <% if owner_faces_count.positive? %>
                      | Owner matches: <strong><%= owner_faces_count %></strong>
                    <% end %>
                    <% if recurring_faces_count.positive? %>
                      | Recurring: <strong><%= recurring_faces_count %></strong>
                    <% end %>
                    <% if face_recognition["detection_source"].to_s.present? %>
                      | Source: <%= face_recognition["detection_source"] %>
                    <% end %>
                    <% if post_people_scope.present? %>
                      | Scope: <strong><%= post_people_scope == "multiple_people" ? "multiple people" : "single person" %></strong>
                    <% end %>
                  </p>
                  <% if face_participants.any? %>
                    <div class="post-face-chip-row">
                      <% face_participants.first(6).each do |participant| %>
                        <% role = participant["role"].to_s.presence || "unknown" %>
                        <% person_id = participant["person_id"].to_i.positive? ? participant["person_id"].to_i : nil %>
                        <% recurring = ActiveModel::Type::Boolean.new.cast(participant["recurring_face"]) || participant["appearances"].to_i > 1 %>
                        <% person = person_id.present? ? post_people_by_id[person_id] : nil %>
                        <% real_person_status = participant["real_person_status"].to_s.presence || person&.real_person_status %>
                        <% confidence = participant["identity_confidence"] %>
                        <% confidence = person&.identity_confidence if confidence.blank? %>
                        <% confidence_percent = confidence.present? ? (confidence.to_f * 100).round : nil %>
                        <% person_label = participant["label"].to_s.presence || (person_id.present? ? "person_#{person_id}" : "person") %>
                        <% person_path = person_id.present? ? instagram_profile_instagram_story_person_path(profile, person_id) : nil %>
                        <% chip_classes = "pill face-pill #{role == "primary_user" ? "owner" : "person"}" %>
                        <span class="face-chip-item">
                          <% if person_path.present? %>
                            <%= link_to person_label, person_path, class: "#{chip_classes} face-pill-link" %>
                          <% else %>
                            <span class="<%= chip_classes %>"><%= person_label %></span>
                          <% end %>
                          <% if recurring || real_person_status.present? || confidence_percent.present? %>
                            <small class="face-chip-meta">
                              <% meta_parts = [] %>
                              <% meta_parts << "recurring" if recurring %>
                              <% meta_parts << real_person_status.to_s.tr("_", " ") if real_person_status.present? %>
                              <% meta_parts << "confidence #{confidence_percent}%" if confidence_percent.present? %>
                              <%= meta_parts.join(" | ") %>
                            </small>
                          <% end %>
                        </span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
              <% if deleted_from_source %>
                <p class="meta story-skipped-badge">Deleted on source: <%= deleted_label %></p>
              <% end %>

              <div class="actions-row">
                <% if download_url.present? %>
                  <a class="btn small secondary" href="<%= download_url %>" target="_blank" rel="noreferrer">Download</a>
                <% end %>
                <% if image_url.present? %>
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    data-action="profile-post-modal#open"
                    data-shortcode="<%= pp.shortcode %>"
                    data-caption="<%= h(pp.caption.to_s) %>"
                    data-likes="<%= pp.likes_count %>"
                    data-comments-count="<%= pp.comments_count %>"
                    data-taken-at="<%= pp.taken_at&.strftime('%Y-%m-%d %H:%M:%S') %>"
                    data-image-url="<%= image_url %>"
                    data-download-url="<%= download_url %>"
                    data-permalink="<%= ig_url %>"
                    data-media-content-type="<%= content_type %>"
                    data-media-preview-image-url="<%= poster_url %>"
                    data-video-static-frame-only="<%= metadata["video_static_frame_only"] %>"
                    data-is-video="<%= is_video %>"
                    data-ai-status="<%= pp.ai_status %>"
                    data-ai-provider="<%= pp.ai_provider %>"
                    data-ai-model="<%= pp.ai_model %>"
                    data-comment-gen-status="<%= comment_gen_status %>"
                    data-comment-gen-source="<%= comment_gen_source %>"
                    data-comment-gen-fallback="<%= comment_gen_fallback %>"
                    data-comment-gen-error="<%= h(comment_gen_error.to_s) %>"
                    data-forward-url="<%= forward_comment_instagram_profile_instagram_profile_post_path(profile, pp) %>"
                    data-comments-json="<%= h(comments.to_json) %>"
                    data-suggestions-json="<%= h(suggestions.to_json) %>"
                    data-face-summary-json="<%= h(face_summary_payload.to_json) %>"
                  >
                    View
                  </button>
                <% end %>
                <% if pp.ai_status != "analyzed" %>
                  <%= button_to "Analyze", analyze_instagram_profile_instagram_profile_post_path(profile, pp), method: :post, class: "btn small" %>
                <% else %>
                  <%= button_to "Re-analyze", analyze_instagram_profile_instagram_profile_post_path(profile, pp), method: :post, class: "btn small secondary" %>
                <% end %>
              </div>
            </div>
          </article>
        <% end %>
        </div>
      </div>

      <div class="modal fade app-media-modal" tabindex="-1" aria-hidden="true" data-profile-post-modal-target="modal">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" data-profile-post-modal-target="title">Post</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" data-profile-post-modal-initial-focus aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-6">
                  <img data-profile-post-modal-target="image" alt="Post media" class="modal-media-image img-fluid rounded border border-secondary-subtle" />
                  <div data-profile-post-modal-target="videoShell" class="story-video-player-shell audit-video-player-shell d-none">
                    <video
                      data-profile-post-modal-target="video"
                      data-controller="video-player"
                      data-video-player-autoplay-value="false"
                      data-video-player-load-on-play-value="true"
                      controls
                      playsinline
                      preload="none"
                    ></video>
                  </div>
                  <div class="d-grid gap-1 mt-2">
                    <p class="meta mb-0" data-profile-post-modal-target="stats"></p>
                    <p class="meta mb-0" data-profile-post-modal-target="meta"></p>
                    <p class="meta mb-0" data-profile-post-modal-target="generation"></p>
                  </div>
                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <a data-profile-post-modal-target="download" class="btn btn-sm btn-outline-light" href="#" target="_blank" rel="noreferrer">Download media</a>
                    <a data-profile-post-modal-target="permalink" class="btn btn-sm btn-outline-light" href="#" target="_blank" rel="noreferrer">Open on Instagram</a>
                  </div>
                </div>
                <div class="col-lg-6 d-grid gap-2 align-content-start">
                  <div>
                    <h6 class="text-uppercase text-secondary-emphasis small mb-1">Caption</h6>
                    <p class="meta mb-0" data-profile-post-modal-target="caption"></p>
                  </div>
                  <div>
                    <h6 class="text-uppercase text-secondary-emphasis small mb-1">Comments</h6>
                    <div data-profile-post-modal-target="comments"></div>
                  </div>
                  <div>
                    <h6 class="text-uppercase text-secondary-emphasis small mb-1">Suggested comments</h6>
                    <p class="meta mb-1">Click <strong>Forward Comment</strong> to queue posting on this exact Instagram post.</p>
                    <div data-profile-post-modal-target="suggestions"></div>
                  </div>
                  <div>
                    <h6 class="text-uppercase text-secondary-emphasis small mb-1">Detected faces</h6>
                    <div data-profile-post-modal-target="faces"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <p class="meta">No captured profile posts yet. Use <strong>Capture Profile Posts</strong> to fetch posts and preserve historical state (including deleted-source flags).</p>
  <% end %>
</section>
