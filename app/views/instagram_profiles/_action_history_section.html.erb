<section id="action_history_section" class="card">
  <h2>Action History</h2>
  <p class="meta">Tracks capture/sync actions. Use this with <strong>History</strong> (Profile History table) to view fetched media and related event actions.</p>

  <% if action_logs.any? %>
    <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="profile-action-history-table" data-table-standard-pagination-size-value="25">
      <div class="table-scroll">
        <table class="table" data-table-standard-target="table">
        <thead>
          <tr>
            <th>When</th>
            <th>Action</th>
            <th>Status</th>
            <th>Source</th>
            <th>Details</th>
            <th>Artifacts</th>
          </tr>
        </thead>
        <tbody>
          <% action_logs.each do |log| %>
            <% metadata = log.metadata.is_a?(Hash) ? log.metadata : {} %>
            <tr>
              <td><%= relative_time_with_tooltip(log.occurred_at) %></td>
              <td><code><%= log.action %></code></td>
              <td><span class="pill <%= log.status == "failed" ? "failed" : (log.status == "succeeded" ? "sent" : (log.status == "queued" ? "queued" : "")) %>"><%= log.status %></span></td>
              <td><%= log.trigger_source.presence || "-" %></td>
              <td class="meta">
                <% if log.error_message.present? %>
                  <strong><%= log.error_message %></strong>
                <% elsif log.log_text.present? %>
                  <%= log.log_text %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="meta">
                <% if log.action == "capture_profile_posts" %>
                  new: <strong><%= metadata["created_count"].to_i %></strong>,
                  restored: <strong><%= metadata["restored_count"].to_i %></strong>,
                  updated: <strong><%= metadata["updated_count"].to_i %></strong>,
                  deleted flagged: <strong><%= metadata["deleted_count"].to_i %></strong>,
                  analysis queued: <strong><%= metadata["analysis_candidates_count"].to_i %></strong><br>
                  <% feed_fetch = metadata["feed_fetch"].is_a?(Hash) ? metadata["feed_fetch"] : {} %>
                  <% if feed_fetch.present? %>
                    source: <code><%= feed_fetch["source"].to_s.presence || "-" %></code>,
                    pages: <strong><%= feed_fetch["pages_fetched"].to_i %></strong><br>
                  <% end %>
                  <a class="btn small secondary" href="#captured_profile_posts_section">Posts</a>
                  <a class="btn small secondary" href="#profile_events_table_<%= log.instagram_profile_id %>">History</a>
                <% elsif log.action == "analyze_profile_posts" %>
                  <% state = metadata["analysis_queue_state"].is_a?(Hash) ? metadata["analysis_queue_state"] : {} %>
                  total: <strong><%= state["total_candidates"].to_i %></strong>,
                  analyzed: <strong><%= state["analyzed_count"].to_i %></strong>,
                  skipped: <strong><%= state["skipped_count"].to_i %></strong>,
                  failed: <strong><%= state["failed_count"].to_i %></strong><br>
                  <a class="btn small secondary" href="#captured_profile_posts_section">Posts</a>
                <% elsif log.action == "build_history" %>
                  <% history = metadata["history_build"].is_a?(Hash) ? metadata["history_build"] : {} %>
                  <% checks = history["checks"].is_a?(Hash) ? history["checks"] : {} %>
                  <% queue = history["queue"].is_a?(Hash) ? history["queue"] : {} %>
                  status: <strong><%= history["status"].to_s.presence || metadata["status"].to_s.presence || "-" %></strong><br>
                  all posts captured: <strong><%= ActiveModel::Type::Boolean.new.cast(checks.dig("all_posts_captured", "ready")) ? "yes" : "no" %></strong>,
                  latest 50 captured: <strong><%= ActiveModel::Type::Boolean.new.cast(checks.dig("latest_50_captured", "ready")) ? "yes" : "no" %></strong>,
                  latest 20 analyzed: <strong><%= ActiveModel::Type::Boolean.new.cast(checks.dig("latest_20_analyzed", "ready")) ? "yes" : "no" %></strong><br>
                  queue downloads: <strong><%= queue["downloads_queued"].to_i %></strong>,
                  queue analyses: <strong><%= queue["analyses_queued"].to_i %></strong>
                  <% retry_meta = metadata["retry"].is_a?(Hash) ? metadata["retry"] : {} %>
                  <% if retry_meta["next_run_at"].to_s.present? %>
                    <br>next retry: <strong><%= relative_time_with_tooltip(retry_meta["next_run_at"]) %></strong>
                  <% end %>
                  <br>
                  <a class="btn small secondary" href="#profile_history_build">Build History</a>
                  <a class="btn small secondary" href="#profile_mutual">Mutual</a>
                <% elsif metadata["post_shortcode"].to_s.present? %>
                  Post: <code><%= metadata["post_shortcode"] %></code><br>
                  <a class="btn small secondary" href="#captured_profile_posts_section">View post</a>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <p class="meta">No profile action history yet.</p>
  <% end %>
</section>
