<% content_for :title, "AI Services" %>
<% runtime_audit = @runtime_audit.is_a?(Hash) ? @runtime_audit : {} %>
<% architecture = runtime_audit[:architecture].is_a?(Hash) ? runtime_audit[:architecture] : {} %>
<% host_services = Array(runtime_audit[:host_services]) %>
<% concurrent_services = Array(runtime_audit[:concurrent_services]) %>
<% cleanup_candidates = Array(runtime_audit[:cleanup_candidates]) %>
<% totals = runtime_audit[:totals].is_a?(Hash) ? runtime_audit[:totals] : {} %>
<% configured_models = architecture[:configured_models].is_a?(Hash) ? architecture[:configured_models] : {} %>
<% available_models = Array(architecture[:ollama_available_models]) %>
<% unused_models = Array(architecture[:unused_ollama_models]) %>
<% lightweight_controls = architecture[:lightweight_controls].is_a?(Hash) ? architecture[:lightweight_controls] : {} %>

<div class="page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1>AI Services</h1>
      <p class="meta">Current local AI runtime status, concurrent lanes, and cleanup candidates.</p>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Dashboard", instagram_accounts_path, class: "btn secondary" %>
      <%= link_to "Background Jobs", admin_background_jobs_path, class: "btn secondary" %>
    </div>
  </header>

  <section class="card">
    <h2>Local AI Stack Status</h2>

    <div id="service-status" class="service-grid">
      <% if @service_status[:status] == "online" %>
        <div class="status-indicator online">
          <div>
            <strong>Local AI stack online</strong>
            <div class="status-time">
              <%= relative_time_with_tooltip(@service_status[:last_check]) %>
              <% if @service_status[:stale] %>
                <span class="meta">(cached, refresh queued)</span>
              <% elsif @service_status[:source].to_s == "live" %>
                <span class="meta">(live check)</span>
              <% end %>
            </div>
          </div>
          <span class="pill">Healthy</span>
        </div>

        <% @service_status[:services].each do |service, active| %>
          <% default_test = get_default_test_for_service(service) %>
          <div class="service-item <%= active ? "active" : "inactive" %>">
            <div class="service-info">
              <span class="service-name"><%= service.to_s.capitalize %></span>
              <span class="service-status"><%= active ? "Active" : "Inactive" %></span>
            </div>
            <% if default_test.present? %>
              <button class="btn btn-small test-service-btn" data-service="<%= service %>" data-test="<%= default_test %>">
                Run test
              </button>
            <% else %>
              <span class="meta">No direct test</span>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="status-indicator offline">
          <div>
            <strong>Local AI stack offline</strong>
            <div class="status-time">
              <%= relative_time_with_tooltip(@service_status[:last_check]) %>
              <% if @service_status[:stale] %>
                <span class="meta">(cached, refresh queued)</span>
              <% elsif @service_status[:source].to_s == "live" %>
                <span class="meta">(live check)</span>
              <% end %>
            </div>
          </div>
          <span class="pill">Unavailable</span>
        </div>
        <div class="error-message">
          <strong>Error:</strong> <%= @service_status[:message] %>
          <p class="hint mb-0">Verify the local Ollama endpoint is reachable.</p>
        </div>
      <% end %>
    </div>

    <div class="actions-row mt-2">
      <button id="refresh-status" class="btn btn-secondary">Refresh status</button>
      <button id="test-all-services" class="btn btn-primary">Run all tests</button>
    </div>
  </section>

  <section class="card">
    <h2>Runtime Architecture</h2>
    <div class="info-grid ai-runtime-grid">
      <div class="info-item">
        <h4>Policy</h4>
        <p class="mb-1">
          Execution mode:
          <code><%= architecture[:execution_mode].to_s.presence || "ollama_only" %></code>
        </p>
        <p class="mb-0">
          Stack status:
          <strong><%= architecture[:stack_status].to_s.presence || "unknown" %></strong>
          |
          Ollama: <strong><%= architecture[:ollama_ok] ? "reachable" : "unreachable" %></strong>
        </p>
      </div>

      <div class="info-item">
        <h4>Configured Models</h4>
        <p class="mb-1">
          <% if configured_models.any? %>
            <% configured_models.each do |role, model_name| %>
              <code><%= role %>:<%= model_name %></code>
            <% end %>
          <% else %>
            <span class="meta">No configured models found.</span>
          <% end %>
        </p>
        <p class="mb-0">
          Installed models:
          <% if available_models.any? %>
            <%= available_models.join(", ") %>
          <% else %>
            <span class="meta">none detected</span>
          <% end %>
        </p>
      </div>

      <div class="info-item">
        <h4>Lightweight Controls</h4>
        <p class="mb-1">
          <code>local_provider_lightweight=<%= lightweight_controls[:local_provider_lightweight_mode] %></code>
          <code>post_video_lightweight=<%= lightweight_controls[:post_video_lightweight_mode] %></code>
        </p>
        <p class="mb-0">
          <code>skip_dynamic_with_audio=<%= lightweight_controls[:skip_dynamic_vision_when_audio_present] %></code>
          <code>frame_sample_limit=<%= lightweight_controls[:post_video_frame_sample_limit] %></code>
          <code>dynamic_keyframes=<%= lightweight_controls[:post_video_dynamic_keyframe_limit] %></code>
        </p>
      </div>
    </div>

    <% if unused_models.any? %>
      <div class="runtime-note warning mt-2">
        <strong>Unused local models detected:</strong>
        <%= unused_models.join(", ") %>
      </div>
    <% end %>
  </section>

  <section class="card">
    <h2>Background Runtime Services</h2>
    <p class="meta mb-1">
      Host services active: <strong><%= totals[:host_services_active].to_i %>/<%= totals[:host_services_total].to_i %></strong>
      | Required missing: <strong><%= totals[:host_services_required_missing].to_i %></strong>
    </p>
    <% if host_services.any? %>
      <div class="table-scroll">
        <table class="table ai-runtime-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Status</th>
              <th>Required</th>
              <th>Port</th>
              <th>Process Matches</th>
              <th>Impact</th>
            </tr>
          </thead>
          <tbody>
            <% host_services.each do |row| %>
              <tr class="<%= row[:active] ? "runtime-row-active" : "runtime-row-idle" %>">
                <td><strong><%= row[:service_name] %></strong></td>
                <td><span class="pill"><%= row[:status].to_s.humanize %></span></td>
                <td><%= row[:required] ? "yes" : "optional" %></td>
                <td>
                  <% if row[:port].present? %>
                    <code><%= row[:port] %></code>
                    <span class="meta">(<%= row[:port_open] ? "open" : "closed" %>)</span>
                  <% else %>
                    <span class="meta">-</span>
                  <% end %>
                </td>
                <td><%= row[:process_count].to_i %></td>
                <td class="meta"><%= row[:impact] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="meta">No runtime service snapshot available.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Concurrent AI Lanes</h2>
    <p class="meta mb-1">
      Backend: <strong><%= runtime_audit[:queue_backend].to_s.presence || "unknown" %></strong>
      | Total lanes: <strong><%= totals[:total_lanes].to_i %></strong>
      | Active lanes: <strong><%= totals[:active_lanes].to_i %></strong>
      | Idle lanes: <strong><%= totals[:idle_lanes].to_i %></strong>
      | Active drain ETA: <strong><%= totals[:active_lane_drain_eta_seconds].to_f.round(1) %>s</strong>
    </p>
    <p class="meta mt-0">Captured at <%= runtime_audit[:captured_at].to_s.presence || "-" %></p>

    <% if concurrent_services.any? %>
      <div class="table-scroll">
        <table class="table ai-runtime-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Queue</th>
              <th>Concurrency</th>
              <th>Pending</th>
              <th>API Calls (24h)</th>
              <th>Failures (24h)</th>
              <th>Tokens (24h)</th>
              <th>New item ETA</th>
              <th>Drain ETA</th>
              <th>ETA confidence</th>
              <th>Job Classes</th>
              <th>Data impact</th>
            </tr>
          </thead>
          <tbody>
            <% concurrent_services.each do |row| %>
              <tr class="<%= row[:active] ? "runtime-row-active" : "runtime-row-idle" %>">
                <td>
                  <strong><%= row[:service_name] %></strong>
                  <div class="meta"><%= row[:category].to_s.humanize %></div>
                </td>
                <td><code><%= row[:queue_name] %></code></td>
                <td><code><%= row[:configured_concurrency] %></code></td>
                <td><%= row[:queue_pending].to_i %></td>
                <td><%= row[:api_calls_24h].to_i %></td>
                <td><%= row[:recent_failures_24h].to_i %></td>
                <td><%= row[:api_total_tokens_24h].to_i %></td>
                <td><%= row[:eta_new_item_seconds].present? ? "#{row[:eta_new_item_seconds]}s" : "-" %></td>
                <td><%= row[:eta_queue_drain_seconds].present? ? "#{row[:eta_queue_drain_seconds]}s" : "-" %></td>
                <td>
                  <span class="pill"><%= row[:eta_confidence].to_s %></span>
                  <div class="meta">n=<%= row[:eta_sample_size].to_i %></div>
                </td>
                <td>
                  <span><%= row[:job_class_count].to_i %> registered</span>
                  <% sample_rows = Array(row[:sampled_job_classes]) %>
                  <% if sample_rows.any? %>
                    <div class="meta">
                      <% sample_rows.first(2).each do |entry| %>
                        <code><%= entry[:key] %>=<%= entry[:count] %></code>
                      <% end %>
                    </div>
                  <% end %>
                </td>
                <td class="meta"><%= row[:data_impact] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="meta">No AI lane metrics available.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Legacy & Cleanup Candidates</h2>
    <% if cleanup_candidates.any? %>
      <div class="runtime-candidate-grid">
        <% cleanup_candidates.each do |candidate| %>
          <% status = candidate[:status].to_s %>
          <% status_class = if status == "safe_to_remove"
            "candidate-remove"
          elsif status == "tune_concurrency"
            "candidate-tune"
          else
            "candidate-keep"
          end %>
          <div class="runtime-candidate <%= status_class %>">
            <div class="runtime-candidate-head">
              <strong><%= candidate[:title] %></strong>
              <span class="pill"><%= status.humanize %></span>
            </div>
            <p class="meta mb-1">Evidence: <%= candidate[:evidence].to_s.presence || "-" %></p>
            <p class="mb-0"><%= candidate[:recommended_action] %></p>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="meta">No cleanup candidates detected.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Test Results</h2>
    <div id="test-results" class="test-results">
      <% if @test_results.present? %>
        <% @test_results.each do |service, result| %>
          <div class="test-result <%= result[:success] ? "success" : "error" %>">
            <div class="test-header">
              <span class="test-service"><%= service.to_s.capitalize %></span>
              <span class="test-status"><%= result[:success] ? "Passed" : "Failed" %></span>
            </div>
            <div class="test-details">
              <% if result[:success] %>
                <p class="test-message"><%= result[:message] %></p>
              <% else %>
                <p class="test-error"><strong>Error:</strong> <%= result[:error] %></p>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <p class="mb-0">No tests run yet. Run an individual service test or run all tests.</p>
        </div>
      <% end %>
    </div>
  </section>

  <section class="card">
    <h2>Available Tests</h2>
    <div class="test-grid">
      <div class="test-category">
        <h3>Ollama</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="ollama" data-test="models">List models</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Service Information</h2>
    <div class="info-grid">
      <div class="info-item">
        <h4>Configuration</h4>
        <p class="mb-1">Execution mode: <code>ollama_only</code></p>
        <p class="mb-0">Ollama endpoint: <code><%= Ai::OllamaClient::BASE_URL %></code></p>
      </div>

      <div class="info-item">
        <h4>Performance</h4>
        <p class="mb-1">Pipelines prioritize lightweight pre-analysis and key-frame sampling.</p>
        <p class="mb-0">Concurrent Sidekiq lanes are isolated for local hardware stability.</p>
      </div>

      <div class="info-item">
        <h4>Privacy</h4>
        <p class="mb-1">No external API dependency is required for local runs.</p>
        <p class="mb-0">Inputs remain inside your own environment.</p>
      </div>
    </div>
  </section>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener("turbo:load", function() {
      const page = document.getElementById("service-status")
      if (!page || page.dataset.bound === "1") return
      page.dataset.bound = "1"

      const refreshButton = document.getElementById("refresh-status")
      const testAllButton = document.getElementById("test-all-services")
      const resultsContainer = document.getElementById("test-results")

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
      }

      function updateTestResults(results, append = false) {
        const rendered = Object.entries(results).map(([service, result]) => {
          const statusClass = result.success ? "success" : "error"
          const statusText = result.success ? "Passed" : "Failed"
          const message = result.success ? (result.message || "Test completed") : (result.error || "Unknown error")

          return `
            <div class="test-result ${statusClass}">
              <div class="test-header">
                <span class="test-service">${escapeHtml(service.charAt(0).toUpperCase() + service.slice(1))}</span>
                <span class="test-status">${statusText}</span>
              </div>
              <div class="test-details">
                <p class="${result.success ? "test-message" : "test-error"}">${escapeHtml(message)}</p>
              </div>
            </div>
          `
        }).join("")

        if (append) {
          resultsContainer.insertAdjacentHTML("afterbegin", rendered)
        } else {
          resultsContainer.innerHTML = rendered
        }
      }

      function showResultModal(service, result) {
        if (!window.modalManager || !window.modalManager.showModal) return
        const status = result.success ? "Passed" : "Failed"
        const message = result.success ? (result.message || "Test completed") : (result.error || "Unknown error")
        const details = result.result ? `<pre>${escapeHtml(JSON.stringify(result.result, null, 2))}</pre>` : ""

        window.modalManager.showModal(`
          <div>
            <h5>${escapeHtml(service.toUpperCase())} test ${escapeHtml(status)}</h5>
            <p class="meta">${escapeHtml(message)}</p>
            ${details}
          </div>
        `, { size: "modal-lg", hideFooter: true })
      }

      function runServiceTest(service, testType, sourceButton) {
        sourceButton.disabled = true
        sourceButton.classList.add("btn-loading")

        const payload = new URLSearchParams()
        payload.set("service_name", service)
        payload.set("test_type", testType)

        fetch("<%= test_service_ai_dashboard_index_path %>", {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: payload.toString()
        })
          .then((response) => response.json())
          .then((result) => {
            updateTestResults({ [service]: result }, true)
            showResultModal(service, result)
          })
          .catch((error) => {
            const result = { success: false, error: error.message }
            updateTestResults({ [service]: result }, true)
            if (window.showErrorModal) showErrorModal("Service test failed", error.message)
          })
          .finally(() => {
            sourceButton.disabled = false
            sourceButton.classList.remove("btn-loading")
          })
      }

      refreshButton?.addEventListener("click", function() {
        window.location.assign("<%= ai_dashboard_index_path(refresh: 1) %>")
      })

      testAllButton?.addEventListener("click", function() {
        const button = this
        button.disabled = true
        button.classList.add("btn-loading")

        fetch("<%= test_all_services_ai_dashboard_index_path %>", {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams().toString()
        })
          .then((response) => response.json())
          .then((results) => {
            updateTestResults(results)
            const values = Object.values(results)
            const passed = values.filter((row) => row.success).length
            if (window.showSuccessModal) {
              showSuccessModal("All tests complete", `${passed}/${values.length} tests passed.`)
            }
          })
          .catch((error) => {
            if (window.showErrorModal) showErrorModal("Run failed", error.message)
          })
          .finally(() => {
            button.disabled = false
            button.classList.remove("btn-loading")
          })
      })

      document.querySelectorAll(".test-service-btn").forEach((button) => {
        button.addEventListener("click", function() {
          runServiceTest(this.dataset.service, this.dataset.test, this)
        })
      })
    })
  </script>
<% end %>
