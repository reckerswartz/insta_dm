<% content_for :title, "AI Services" %>

<div class="page">
  <header class="page-header">
    <h1>AI Services</h1>
    <p class="meta">Run service checks and view response payloads without leaving the dashboard.</p>
  </header>

  <section class="card">
    <h2>Service Status</h2>

    <div id="service-status" class="service-grid">
      <% if @service_status[:status] == "online" %>
        <div class="status-indicator online">
          <div>
            <strong>AI microservice online</strong>
            <div class="status-time"><%= relative_time_with_tooltip(@service_status[:last_check]) %></div>
          </div>
          <span class="pill">Healthy</span>
        </div>

        <% @service_status[:services].each do |service, active| %>
          <div class="service-item <%= active ? "active" : "inactive" %>">
            <div class="service-info">
              <span class="service-name"><%= service.capitalize %></span>
              <span class="service-status"><%= active ? "Active" : "Inactive" %></span>
            </div>
            <button class="btn btn-small test-service-btn" data-service="<%= service %>" data-test="<%= get_default_test_for_service(service) %>">
              Run test
            </button>
          </div>
        <% end %>
      <% else %>
        <div class="status-indicator offline">
          <div>
            <strong>AI microservice offline</strong>
            <div class="status-time"><%= relative_time_with_tooltip(@service_status[:last_check]) %></div>
          </div>
          <span class="pill">Unavailable</span>
        </div>
        <div class="error-message">
          <strong>Error:</strong> <%= @service_status[:message] %>
          <p class="hint mb-0">Ensure the microservice is running on <code>localhost:8000</code>.</p>
        </div>
      <% end %>
    </div>

    <div class="actions-row mt-2">
      <button id="refresh-status" class="btn btn-secondary">Refresh status</button>
      <button id="test-all-services" class="btn btn-primary">Run all tests</button>
    </div>
  </section>

  <section class="card">
    <h2>Test Results</h2>
    <div id="test-results" class="test-results">
      <% if @test_results.present? %>
        <% @test_results.each do |service, result| %>
          <div class="test-result <%= result[:success] ? "success" : "error" %>">
            <div class="test-header">
              <span class="test-service"><%= service.to_s.capitalize %></span>
              <span class="test-status"><%= result[:success] ? "Passed" : "Failed" %></span>
            </div>
            <div class="test-details">
              <% if result[:success] %>
                <p class="test-message"><%= result[:message] %></p>
              <% else %>
                <p class="test-error"><strong>Error:</strong> <%= result[:error] %></p>
              <% end %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="empty-state">
          <p class="mb-0">No tests run yet. Run an individual service test or run all tests.</p>
        </div>
      <% end %>
    </div>
  </section>

  <section class="card">
    <h2>Available Tests</h2>
    <div class="test-grid">
      <div class="test-category">
        <h3>Vision</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="vision" data-test="labels">Object detection</button>
          <button class="btn btn-small test-service-btn" data-service="vision" data-test="safe_search">Safe search</button>
        </div>
      </div>

      <div class="test-category">
        <h3>Face</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="face" data-test="detection">Face detection</button>
          <button class="btn btn-small test-service-btn" data-service="face" data-test="embedding">Face embedding</button>
          <button class="btn btn-small test-service-btn" data-service="face" data-test="comparison">Face comparison</button>
        </div>
      </div>

      <div class="test-category">
        <h3>OCR</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="ocr" data-test="text_extraction">Text extraction</button>
        </div>
      </div>

      <div class="test-category">
        <h3>Whisper</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="whisper" data-test="transcription">Audio transcription</button>
        </div>
      </div>

      <div class="test-category">
        <h3>Video</h3>
        <div class="test-list">
          <button class="btn btn-small test-service-btn" data-service="video" data-test="analysis">Video analysis</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Service Information</h2>
    <div class="info-grid">
      <div class="info-item">
        <h4>Configuration</h4>
        <p class="mb-1">Service endpoint: <code>localhost:8000</code></p>
        <p class="mb-0">Vision, face, OCR, whisper, and video services are supported.</p>
      </div>

      <div class="info-item">
        <h4>Performance</h4>
        <p class="mb-1">Services run locally for low-latency processing.</p>
        <p class="mb-0">Model warm-up happens during service startup.</p>
      </div>

      <div class="info-item">
        <h4>Privacy</h4>
        <p class="mb-1">No external API dependency is required for local runs.</p>
        <p class="mb-0">Inputs remain inside your own environment.</p>
      </div>
    </div>
  </section>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener("turbo:load", function() {
      const page = document.getElementById("service-status")
      if (!page || page.dataset.bound === "1") return
      page.dataset.bound = "1"

      const refreshButton = document.getElementById("refresh-status")
      const testAllButton = document.getElementById("test-all-services")
      const resultsContainer = document.getElementById("test-results")

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
      }

      function updateTestResults(results, append = false) {
        const rendered = Object.entries(results).map(([service, result]) => {
          const statusClass = result.success ? "success" : "error"
          const statusText = result.success ? "Passed" : "Failed"
          const message = result.success ? (result.message || "Test completed") : (result.error || "Unknown error")

          return `
            <div class="test-result ${statusClass}">
              <div class="test-header">
                <span class="test-service">${escapeHtml(service.charAt(0).toUpperCase() + service.slice(1))}</span>
                <span class="test-status">${statusText}</span>
              </div>
              <div class="test-details">
                <p class="${result.success ? "test-message" : "test-error"}">${escapeHtml(message)}</p>
              </div>
            </div>
          `
        }).join("")

        if (append) {
          resultsContainer.insertAdjacentHTML("afterbegin", rendered)
        } else {
          resultsContainer.innerHTML = rendered
        }
      }

      function showResultModal(service, result) {
        if (!window.modalManager || !window.modalManager.showModal) return
        const status = result.success ? "Passed" : "Failed"
        const message = result.success ? (result.message || "Test completed") : (result.error || "Unknown error")
        const details = result.result ? `<pre>${escapeHtml(JSON.stringify(result.result, null, 2))}</pre>` : ""

        window.modalManager.showModal(`
          <div>
            <h5>${escapeHtml(service.toUpperCase())} test ${escapeHtml(status)}</h5>
            <p class="meta">${escapeHtml(message)}</p>
            ${details}
          </div>
        `, { size: "modal-lg", hideFooter: true })
      }

      function runServiceTest(service, testType, sourceButton) {
        sourceButton.disabled = true
        sourceButton.classList.add("btn-loading")

        const payload = new URLSearchParams()
        payload.set("service_name", service)
        payload.set("test_type", testType)

        fetch("<%= test_service_ai_dashboard_index_path %>", {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: payload.toString()
        })
          .then((response) => response.json())
          .then((result) => {
            updateTestResults({ [service]: result }, true)
            showResultModal(service, result)
          })
          .catch((error) => {
            const result = { success: false, error: error.message }
            updateTestResults({ [service]: result }, true)
            if (window.showErrorModal) showErrorModal("Service test failed", error.message)
          })
          .finally(() => {
            sourceButton.disabled = false
            sourceButton.classList.remove("btn-loading")
          })
      }

      refreshButton?.addEventListener("click", function() {
        window.location.reload()
      })

      testAllButton?.addEventListener("click", function() {
        const button = this
        button.disabled = true
        button.classList.add("btn-loading")

        fetch("<%= test_all_services_ai_dashboard_index_path %>", {
          method: "POST",
          headers: {
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams().toString()
        })
          .then((response) => response.json())
          .then((results) => {
            updateTestResults(results)
            const values = Object.values(results)
            const passed = values.filter((row) => row.success).length
            if (window.showSuccessModal) {
              showSuccessModal("All tests complete", `${passed}/${values.length} tests passed.`)
            }
          })
          .catch((error) => {
            if (window.showErrorModal) showErrorModal("Run failed", error.message)
          })
          .finally(() => {
            button.disabled = false
            button.classList.remove("btn-loading")
          })
      })

      document.querySelectorAll(".test-service-btn").forEach((button) => {
        button.addEventListener("click", function() {
          runServiceTest(this.dataset.service, this.dataset.test, this)
        })
      })
    })
  </script>
<% end %>
