<% content_for :title, "Feed Posts" %>

<div class="page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1>Feed Posts</h1>
      <p class="meta">Captured from your home feed during feed capture runs. Analyze results and decide manual interactions.</p>
    </div>
    <div class="page-toolbar-actions">
      <% if current_account %>
        <%= link_to "Account Dashboard", instagram_account_path(current_account), class: "btn secondary" %>
      <% end %>
    </div>
  </header>

  <section class="card">
    <h2>Capture</h2>
    <p class="meta">Queues a short capture run that scrolls periodically and records visible posts (no auto-like/comment).</p>
    <% capture_locked = feed_capture_enqueue_locked?(account: @account) %>
    <% next_allowed_at = feed_capture_next_allowed_at(account: @account) %>

    <div class="actions-row">
      <%= button_to(capture_locked ? "Capture Feed (Queued)" : "Capture Feed (Background)",
            feed_capture_path(rounds: 4, delay_seconds: 45, max_new: 20),
            method: :post,
            disabled: capture_locked,
            form: { data: { turbo_submits_with: "Queueing..." } }) %>
    </div>
    <p class="meta">
      <% if capture_locked && next_allowed_at.present? %>
        Feed capture is already queued/running. Next manual trigger is available <strong><%= relative_time_with_tooltip(next_allowed_at) %></strong>.
      <% else %>
        Manual capture is ready. Autonomous capture is handled by the continuous-processing scheduler.
      <% end %>
    </p>
  </section>

  <%= render "instagram_accounts/feed_capture_activity_section", account: @account, feed_capture_activity_entries: @feed_capture_activity_entries %>

  <section class="card">
    <h2>Posts Data Table</h2>

    <div
      class="tabulator-shell"
      data-controller="posts-table"
      data-posts-table-url-value="<%= instagram_posts_path(format: :json) %>"
      data-posts-table-account-id-value="<%= current_account&.id.to_i %>"
    >
      <%= render "shared/table_meta_bar" %>
      <div class="tabulator-host" data-posts-table-target="table"></div>
    </div>
  </section>
</div>
