<% content_for :title, "Post #{@post.shortcode}" %>

<div class="page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1>Post <code><%= @post.shortcode %></code></h1>
      <p class="meta">
        Author: <strong><%= @post.author_username.presence || "-" %></strong>
        | Detected: <strong><%= relative_time_with_tooltip(@post.detected_at) %></strong>
        | Status: <strong><%= @post.status %></strong>
      </p>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Back to Posts", instagram_posts_path, class: "btn secondary" %>
      <% if @post.instagram_profile %>
        <%= link_to "Open Profile", instagram_profile_path(@post.instagram_profile), class: "btn secondary" %>
      <% end %>
      <%= link_to "Open on Instagram", @post.permalink, target: "_blank", rel: "noreferrer", class: "btn" %>
    </div>
  </header>

  <section class="card">
    <h2>Media</h2>
    <% if @post.media.attached? %>
      <div class="actions-row">
        <%= link_to "download", rails_blob_path(@post.media, disposition: "attachment"), class: "btn secondary" %>
      </div>

      <% if @post.media.blob&.content_type.to_s.start_with?("video/") %>
        <%= video_tag rails_blob_path(@post.media), controls: true, class: "modal-media-image" %>
      <% else %>
        <%= image_tag @post.media, class: "modal-media-image" %>
      <% end %>
    <% else %>
      <p class="meta">No media attached yet.</p>
      <% if @post.media_url.present? %>
        <p class="meta">Media URL present, download is queued during capture.</p>
      <% end %>
    <% end %>
  </section>

  <section class="card">
    <h2>AI Analysis</h2>
    <% if @latest_analysis.present? %>
      <p class="meta">
        Provider: <strong><%= @latest_analysis.provider %></strong>
        <% if @latest_analysis.model.present? %>
          | Model: <strong><%= @latest_analysis.model %></strong>
        <% end %>
        | Status: <strong><%= @latest_analysis.status %></strong>
      </p>

      <% if @latest_analysis.analysis.present? %>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(@latest_analysis.analysis) rescue @latest_analysis.analysis.to_json %></pre>
        </div>
      <% else %>
        <p class="meta">No parsed analysis payload for the latest run.</p>
      <% end %>
    <% elsif @post.analysis.present? %>
      <div class="table-scroll">
        <pre class="meta json-pre"><%= JSON.pretty_generate(@post.analysis) rescue @post.analysis.to_json %></pre>
      </div>
    <% else %>
      <p class="meta">Not analyzed yet.</p>
    <% end %>

    <% if @post.metadata.is_a?(Hash) && @post.metadata["face_recognition"].present? %>
      <% face_recognition = @post.metadata["face_recognition"].is_a?(Hash) ? @post.metadata["face_recognition"] : {} %>
      <% identity = face_recognition["identity"].is_a?(Hash) ? face_recognition["identity"] : {} %>
      <% participants = Array(identity["participants"]).select { |row| row.is_a?(Hash) } %>
      <% people_by_id = @post.instagram_post_faces.includes(:instagram_story_person).map(&:instagram_story_person).compact.index_by(&:id) %>
      <% unique_people_count = @post.instagram_post_faces.map(&:instagram_story_person_id).compact.uniq.count %>
      <div class="post-face-summary mt-section">
        <p class="meta">
          Faces: <strong><%= face_recognition["face_count"].to_i %></strong>
          <% if unique_people_count.positive? %>
            | People in post: <strong><%= unique_people_count %></strong>
          <% end %>
          <% if face_recognition["detection_source"].to_s.present? %>
            | Source: <%= face_recognition["detection_source"] %>
          <% end %>
        </p>
        <% if participants.any? %>
          <div class="post-face-chip-row">
            <% participants.first(10).each do |participant| %>
              <% role = participant["role"].to_s.presence || "unknown" %>
              <% person_id = participant["person_id"].to_i.positive? ? participant["person_id"].to_i : nil %>
              <% person = person_id.present? ? people_by_id[person_id] : nil %>
              <% label = participant["label"].to_s.presence || (person_id.present? ? "person_#{person_id}" : "person") %>
              <% person_path = if person_id.present? && @post.instagram_profile.present?
                instagram_profile_instagram_story_person_path(@post.instagram_profile, person_id)
              end %>
              <% pill_class = "pill face-pill #{role == "primary_user" ? "owner" : "person"}" %>
              <span class="face-chip-item">
                <% if person_path.present? %>
                  <%= link_to label, person_path, class: "#{pill_class} face-pill-link" %>
                <% else %>
                  <span class="<%= pill_class %>"><%= label %></span>
                <% end %>
                <% details = [] %>
                <% details << "recurring" if participant["appearances"].to_i > 1 %>
                <% details << participant["real_person_status"].to_s.tr("_", " ") if participant["real_person_status"].to_s.present? %>
                <% confidence = participant["identity_confidence"] %>
                <% confidence = person&.identity_confidence if confidence.blank? %>
                <% details << "confidence #{(confidence.to_f * 100).round}%" if confidence.present? %>
                <% if details.any? %>
                  <small class="face-chip-meta"><%= details.join(" | ") %></small>
                <% end %>
              </span>
            <% end %>
          </div>
          <% if identity["participant_summary_text"].to_s.present? %>
            <p class="meta"><%= identity["participant_summary_text"] %></p>
          <% end %>
        <% end %>
      </div>
      <details class="details-box mt-section">
        <summary>Show Face Recognition Metadata</summary>
        <div class="table-scroll">
          <pre class="meta json-pre"><%= JSON.pretty_generate(@post.metadata["face_recognition"]) rescue @post.metadata["face_recognition"].to_json %></pre>
        </div>
      </details>
    <% end %>
  </section>

</div>
