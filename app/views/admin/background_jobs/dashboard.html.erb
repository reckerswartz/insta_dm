<% content_for :title, "Background Jobs" %>

<div class="page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1>Background Jobs</h1>
      <p class="meta">Unified jobs view: Mission Control + queue backend state + app failure logs with account/system categorization.</p>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Dashboard", instagram_accounts_path, class: "btn secondary" %>
      <%= link_to "Failure Logs", admin_background_job_failures_path, class: "btn secondary" %>
      <%= link_to "Issues", admin_issues_path, class: "btn secondary" %>
    </div>
  </header>

  <section class="card">
    <h2>Mission Control</h2>
    <p class="meta">Open the full Mission Control UI for queue operations and inspection.</p>
    <div class="actions-row">
      <%= link_to "Open Mission Control", "/admin/jobs", class: "btn secondary", target: "_blank", rel: "noreferrer" %>
      <%= link_to "Failure Logs", admin_background_job_failures_path, class: "btn secondary" %>
      <%= link_to "Application Issues", admin_issues_path, class: "btn secondary" %>
      <%= link_to "Storage Ingestions", admin_storage_ingestions_path, class: "btn secondary" %>
      <%= button_to "Stop All Jobs & Clear Queue",
          admin_clear_all_background_jobs_path,
          method: :post,
          class: "btn danger",
          form: {
            data: {
              confirm_modal: true,
              confirm_title: "Clear all queued jobs?",
              confirm_message: "This will stop running jobs and clear queued/retry/dead entries. This action cannot be undone.",
              modal_loading_text: "Clearing queue..."
            }
          } %>
    </div>
  </section>

  <section class="card">
    <h2>Queue State</h2>
    <% if @backend == "sidekiq" %>
      <div class="stack">
        <div class="meta">
          Backend: <strong>Sidekiq</strong>
          | Enqueued: <strong><%= @counts[:enqueued] %></strong>
          | Scheduled: <strong><%= @counts[:scheduled] %></strong>
          | Retries: <strong><%= @counts[:retries] %></strong>
          | Dead: <strong><%= @counts[:dead] %></strong>
          | Processes: <strong><%= @counts[:processes] %></strong>
        </div>
        <% if Array(@counts[:queues]).any? %>
          <div class="meta">
            Queues:
            <% @counts[:queues].sort_by { |row| row[:name].to_s }.each do |row| %>
              <code><%= row[:name] %>=<%= row[:size] %></code>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="stack">
        <div class="meta">
          Backend: <strong>Solid Queue</strong>
          | Jobs total: <strong><%= @counts[:jobs_total] %></strong>
          | Ready: <strong><%= @counts[:ready] %></strong>
          | Scheduled: <strong><%= @counts[:scheduled] %></strong>
          | Claimed: <strong><%= @counts[:claimed] %></strong>
          | Blocked: <strong><%= @counts[:blocked] %></strong>
          | Failed: <strong><%= @counts[:failed] %></strong>
          | Paused queues: <strong><%= @counts[:pauses] %></strong>
        </div>
      </div>
    <% end %>
  </section>

  <section class="card">
    <h2>Queue ETA Forecast (DB-backed)</h2>
    <% queue_estimate_snapshot = @queue_estimates.is_a?(Hash) ? @queue_estimates : {} %>
    <% queue_estimates = Array(queue_estimate_snapshot[:estimates]) %>
    <p class="meta">
      Captured at <%= queue_estimate_snapshot[:captured_at].to_s.presence || "-" %>
      | Lookback: <strong><%= queue_estimate_snapshot[:lookback_window_hours].to_i %>h</strong>
      | Queues: <strong><%= queue_estimate_snapshot[:queue_count].to_i %></strong>
      | Items queued: <strong><%= queue_estimate_snapshot[:queued_items_total].to_i %></strong>
    </p>
    <% if queue_estimates.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-queue-estimates-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Queue</th>
                <th>Size</th>
                <th>Latency (s)</th>
                <th>Concurrency</th>
                <th>Median proc (ms)</th>
                <th>Median wait (ms)</th>
                <th>New item ETA (s)</th>
                <th>Drain ETA (s)</th>
                <th>Confidence</th>
                <th>Samples</th>
              </tr>
            </thead>
            <tbody>
              <% queue_estimates.each do |row| %>
                <tr>
                  <td><code><%= row[:queue_name] %></code></td>
                  <td><%= row[:queue_size].to_i %></td>
                  <td><%= row[:queue_latency_seconds].to_f.round(1) %></td>
                  <td><%= row[:estimated_concurrency].to_f.round(2) %></td>
                  <td><%= row[:median_processing_ms].present? ? row[:median_processing_ms] : "-" %></td>
                  <td><%= row[:median_queue_wait_ms].present? ? row[:median_queue_wait_ms] : "-" %></td>
                  <td><strong><%= row[:estimated_new_item_total_seconds].to_f.round(1) %></strong></td>
                  <td><%= row[:estimated_queue_drain_seconds].to_f.round(1) %></td>
                  <td><span class="pill"><%= row[:confidence].to_s %></span></td>
                  <td><%= row[:sample_size].to_i %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No queue ETA data available yet.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Execution Timing Metrics (24h)</h2>
    <% execution_snapshot = @job_execution_metrics.is_a?(Hash) ? @job_execution_metrics : {} %>
    <% execution_rows = Array(execution_snapshot[:queues]) %>
    <p class="meta">
      Captured at <%= execution_snapshot[:captured_at].to_s.presence || "-" %>
      | Total: <strong><%= execution_snapshot[:total_rows].to_i %></strong>
      | Completed: <strong><%= execution_snapshot[:completed_rows].to_i %></strong>
      | Failed: <strong><%= execution_snapshot[:failed_rows].to_i %></strong>
      | Avg wait: <strong><%= execution_snapshot[:avg_queue_wait_ms].present? ? execution_snapshot[:avg_queue_wait_ms] : "-" %>ms</strong>
      | Avg processing: <strong><%= execution_snapshot[:avg_processing_ms].present? ? execution_snapshot[:avg_processing_ms] : "-" %>ms</strong>
    </p>
    <% if execution_rows.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-execution-metrics-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Queue</th>
                <th>Total</th>
                <th>Completed</th>
                <th>Failed</th>
                <th>Median proc (ms)</th>
                <th>P90 proc (ms)</th>
                <th>Median wait (ms)</th>
                <th>Avg total (ms)</th>
                <th>Last seen</th>
              </tr>
            </thead>
            <tbody>
              <% execution_rows.each do |row| %>
                <tr>
                  <td><code><%= row[:queue_name] %></code></td>
                  <td><%= row[:total_rows].to_i %></td>
                  <td><%= row[:completed_rows].to_i %></td>
                  <td><%= row[:failed_rows].to_i %></td>
                  <td><%= row[:median_processing_ms].present? ? row[:median_processing_ms] : "-" %></td>
                  <td><%= row[:p90_processing_ms].present? ? row[:p90_processing_ms] : "-" %></td>
                  <td><%= row[:median_queue_wait_ms].present? ? row[:median_queue_wait_ms] : "-" %></td>
                  <td><%= row[:avg_total_ms].present? ? row[:avg_total_ms] : "-" %></td>
                  <td><%= row[:last_recorded_at].to_s.presence || "-" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No recorded terminal job timings yet. Metrics appear once jobs complete or fail.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Service Output Audit (24h)</h2>
    <% service_audit = @service_output_audits.is_a?(Hash) ? @service_output_audits : {} %>
    <% service_rows = Array(service_audit[:services]) %>
    <p class="meta">
      Captured at <%= service_audit[:captured_at].to_s.presence || "-" %>
      | Rows: <strong><%= service_audit[:total_rows].to_i %></strong>
      | Completed: <strong><%= service_audit[:completed_rows].to_i %></strong>
      | Failed: <strong><%= service_audit[:failed_rows].to_i %></strong>
      | Unique services: <strong><%= service_audit[:unique_services].to_i %></strong>
      | Avg produced keys: <strong><%= service_audit[:avg_produced_count].presence || "-" %></strong>
      | Avg unused keys: <strong><%= service_audit[:avg_unused_count].presence || "-" %></strong>
    </p>
    <% if service_rows.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-service-output-audit-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Service</th>
                <th>Executions</th>
                <th>Completed</th>
                <th>Failed</th>
                <th>Avg produced</th>
                <th>Avg persisted</th>
                <th>Avg referenced</th>
                <th>Avg unused</th>
                <th>Persisted %</th>
                <th>Used %</th>
                <th>Unused %</th>
                <th>Top unused keys</th>
              </tr>
            </thead>
            <tbody>
              <% service_rows.each do |row| %>
                <tr>
                  <td><code><%= row[:service_name] %></code></td>
                  <td><%= row[:executions].to_i %></td>
                  <td><%= row[:completed].to_i %></td>
                  <td><%= row[:failed].to_i %></td>
                  <td><%= row[:avg_produced_count].to_f.round(2) %></td>
                  <td><%= row[:avg_persisted_count].to_f.round(2) %></td>
                  <td><%= row[:avg_referenced_count].to_f.round(2) %></td>
                  <td><%= row[:avg_unused_count].to_f.round(2) %></td>
                  <td><%= row[:persisted_ratio].to_f.round(2) %></td>
                  <td><%= row[:used_ratio].to_f.round(2) %></td>
                  <td><%= row[:unused_ratio].to_f.round(2) %></td>
                  <td class="meta">
                    <% top_keys = Array(row[:top_unused_keys]) %>
                    <% if top_keys.any? %>
                      <% top_keys.first(5).each do |key_row| %>
                        <code><%= key_row[:key] %>=<%= key_row[:count] %></code>
                      <% end %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <% global_unused = Array(service_audit[:top_unused_leaf_keys]) %>
      <% if global_unused.any? %>
        <p class="meta">
          Global top unused keys:
          <% global_unused.first(8).each do |row| %>
            <code><%= row[:key] %>=<%= row[:count] %></code>
          <% end %>
        </p>
      <% end %>
    <% else %>
      <p class="meta">No service output audit rows yet. Records appear once instrumented services execute.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>AI Service Queue Metrics (24h)</h2>
    <% ai_metrics = @ai_service_queue_metrics.is_a?(Hash) ? @ai_service_queue_metrics : {} %>
    <% ai_services = Array(ai_metrics[:services]) %>
    <p class="meta">
      Captured at <%= ai_metrics[:captured_at].to_s.presence || "-" %>
      | Queue pending total: <strong><%= ai_metrics[:queue_pending_total].to_i %></strong>
      | API calls: <strong><%= ai_metrics[:api_calls_total_24h].to_i %></strong>
      | API failures: <strong><%= ai_metrics[:api_failed_calls_total_24h].to_i %></strong>
    </p>
    <% if ai_services.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-ai-service-metrics-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Service</th>
                <th>Queue</th>
                <th>Pending</th>
                <th>Failures (24h)</th>
                <th>API calls (24h)</th>
                <th>API failed (24h)</th>
                <th>Avg latency (ms)</th>
                <th>Tokens (24h)</th>
              </tr>
            </thead>
            <tbody>
              <% ai_services.each do |row| %>
                <tr>
                  <td>
                    <strong><%= row[:service_name] %></strong>
                    <div class="meta"><%= row[:category].to_s.humanize %></div>
                  </td>
                  <td><code><%= row[:queue_name] %></code></td>
                  <td><%= row[:queue_pending].to_i %></td>
                  <td><%= row[:recent_failures_24h].to_i %></td>
                  <td><%= row[:api_calls_24h].to_i %></td>
                  <td><%= row[:api_failed_calls_24h].to_i %></td>
                  <td><%= row[:api_avg_latency_ms_24h].present? ? row[:api_avg_latency_ms_24h] : "-" %></td>
                  <td><%= row[:api_total_tokens_24h].to_i %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <% unmapped = Array(ai_metrics[:unmapped_ai_queue_jobs]) %>
      <% if unmapped.any? %>
        <p class="meta">
          Unmapped sampled AI queue jobs:
          <% unmapped.each do |entry| %>
            <code><%= entry[:key] %>=<%= entry[:count] %></code>
          <% end %>
        </p>
      <% end %>
    <% else %>
      <p class="meta">No AI service queue metrics available.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Pipeline Pending Backlog</h2>
    <% pending_snapshot = @pipeline_pending_snapshot.is_a?(Hash) ? @pipeline_pending_snapshot : {} %>
    <% posts_pending = pending_snapshot[:posts].is_a?(Hash) ? pending_snapshot[:posts] : {} %>
    <% stories_pending = pending_snapshot[:story_events].is_a?(Hash) ? pending_snapshot[:story_events] : {} %>
    <% captured_at = begin Time.zone.parse(pending_snapshot[:captured_at].to_s) rescue nil end %>
    <p class="meta">
      Captured at <%= captured_at.present? ? captured_at.iso8601(3) : (pending_snapshot[:captured_at].to_s.presence || "-") %>
      | Stale threshold: <strong><%= pending_snapshot[:stale_after_minutes].to_i %>m</strong>
      | Pending posts: <strong><%= posts_pending[:pending_total].to_i %></strong>
      | Pending stories: <strong><%= stories_pending[:pending_total].to_i %></strong>
    </p>
    <div class="meta">
      Posts: running <strong><%= posts_pending[:running_total].to_i %></strong>,
      queued <strong><%= posts_pending[:queued_total].to_i %></strong>,
      overdue <strong><%= posts_pending[:overdue_total].to_i %></strong>,
      stale <strong><%= posts_pending[:stale_total].to_i %></strong>.
      Stories: running <strong><%= stories_pending[:running_total].to_i %></strong>,
      queued <strong><%= stories_pending[:queued_total].to_i %></strong>,
      overdue <strong><%= stories_pending[:overdue_total].to_i %></strong>,
      stale <strong><%= stories_pending[:stale_total].to_i %></strong>.
    </div>

    <% reason_rows = Array(posts_pending[:reasons]).map { |row| row.merge(pipeline: "post") } + Array(stories_pending[:reasons]).map { |row| row.merge(pipeline: "story") } %>
    <% if reason_rows.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-pipeline-pending-reasons-table" data-table-standard-pagination-size-value="20">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Pipeline</th>
                <th>Reason</th>
                <th>Blocking step</th>
                <th>Queue</th>
                <th>Pending</th>
                <th>Median ETA (s)</th>
                <th>P90 ETA (s)</th>
                <th>Overdue</th>
              </tr>
            </thead>
            <tbody>
              <% reason_rows.each do |row| %>
                <tr>
                  <td><span class="pill"><%= row[:pipeline].to_s %></span></td>
                  <td><code><%= row[:reason_code] %></code></td>
                  <td><code><%= row[:blocking_step] %></code></td>
                  <td><code><%= row[:queue_name].to_s.presence || "-" %></code></td>
                  <td><%= row[:count].to_i %></td>
                  <td><%= row[:eta_seconds_median].present? ? row[:eta_seconds_median].to_i : "-" %></td>
                  <td><%= row[:eta_seconds_p90].present? ? row[:eta_seconds_p90].to_i : "-" %></td>
                  <td><%= row[:overdue_count].to_i %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No pending pipeline reason data.</p>
    <% end %>

    <% item_rows = Array(posts_pending[:items]).map { |row| row.merge(pipeline: "post") } + Array(stories_pending[:items]).map { |row| row.merge(pipeline: "story") } %>
    <% if item_rows.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-pipeline-pending-items-table" data-table-standard-pagination-size-value="20">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Pipeline</th>
                <th>Entity</th>
                <th>Profile</th>
                <th>Status</th>
                <th>Blocking step</th>
                <th>Reason</th>
                <th>ETA (s)</th>
                <th>Ready at</th>
                <th>Pending since / updated</th>
                <th>Retry at</th>
              </tr>
            </thead>
            <tbody>
              <% item_rows.each do |row| %>
                <% ready_at = begin Time.zone.parse(row[:estimated_ready_at].to_s) rescue nil end %>
                <% since_at = begin Time.zone.parse(row[:pending_since_at].to_s) rescue nil end %>
                <% updated_at = begin Time.zone.parse(row[:updated_at].to_s) rescue nil end %>
                <% retry_at = begin Time.zone.parse(row[:next_retry_at].to_s) rescue nil end %>
                <tr>
                  <td><span class="pill"><%= row[:pipeline].to_s %></span></td>
                  <td>
                    <% if row[:pipeline].to_s == "post" %>
                      Post #<%= row[:post_id] %>
                      <% if row[:shortcode].to_s.present? %>
                        · <code><%= row[:shortcode] %></code>
                      <% end %>
                    <% else %>
                      Event #<%= row[:event_id] %>
                      <% if row[:story_id].to_s.present? %>
                        · Story <code><%= row[:story_id] %></code>
                      <% end %>
                    <% end %>
                  </td>
                  <td>
                    <%= row[:profile_username].to_s.presence || "-" %>
                    <% if row[:instagram_profile_id].to_i.positive? %>
                      (<code><%= row[:instagram_profile_id] %></code>)
                    <% end %>
                  </td>
                  <td><%= row[:status].to_s.presence || "-" %></td>
                  <td><code><%= row[:blocking_step].to_s.presence || "-" %></code></td>
                  <td><code><%= row[:pending_reason_code].to_s.presence || "-" %></code></td>
                  <td>
                    <% eta_seconds = row[:eta_seconds] %>
                    <% if eta_seconds.present? %>
                      <%= eta_seconds.to_i %>
                      <% if row[:overdue] %>
                        <span class="pill failed">overdue</span>
                      <% end %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td><%= ready_at.present? ? relative_time_with_tooltip(ready_at) : "-" %></td>
                  <td>
                    <% if since_at.present? %>
                      <%= relative_time_with_tooltip(since_at) %>
                    <% elsif updated_at.present? %>
                      <%= relative_time_with_tooltip(updated_at) %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td><%= retry_at.present? ? relative_time_with_tooltip(retry_at) : "-" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No pending pipeline items.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Recent Jobs (All)</h2>
    <% if @recent_jobs.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-recent-jobs-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>Queued</th>
              <th>Scheduled for</th>
              <th>Job</th>
              <th>Queue</th>
              <th>Queue state</th>
              <th>Scheduler</th>
              <th>Scheduling reason</th>
              <th>Scope</th>
              <th>Context</th>
              <th>Active Job ID</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_jobs.each do |j| %>
              <% queued_at = j[:created_at] %>
              <% scheduled_for_at = j[:scheduled_for_at] %>
              <% queue_state = j[:queue_state].to_s.presence || j[:status].to_s %>
              <% state_class =
                  case queue_state
                  when "scheduled", "queued", "processing"
                    "queued"
                  when "retry", "dead", "failed"
                    "failed"
                  when "finished", "completed"
                    "sent"
                  else
                    ""
                  end %>
              <tr>
                <td>
                  <% if queued_at.present? %>
                    <%= relative_time_with_tooltip(queued_at) %>
                    <div class="meta"><%= queued_at.in_time_zone.strftime("%Y-%m-%d %H:%M:%S %Z") %></div>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td>
                  <% if scheduled_for_at.present? %>
                    <%= relative_time_with_tooltip(scheduled_for_at) %>
                    <div class="meta"><%= scheduled_for_at.in_time_zone.strftime("%Y-%m-%d %H:%M:%S %Z") %></div>
                  <% elsif queue_state == "queued" %>
                    <span class="meta">Immediate (no delay)</span>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td><code><%= j[:class_name] %></code></td>
                <td><code><%= j[:queue_name].presence || "-" %></code></td>
                <td><span class="pill <%= state_class %>"><%= queue_state.presence || "-" %></span></td>
                <td class="meta"><%= j[:scheduler_service].presence || "-" %></td>
                <td class="meta">
                  <strong><%= j[:scheduling_reason].presence || "-" %></strong>
                  <% if j[:scheduling_reason_code].to_s.present? %>
                    <div><code><%= j[:scheduling_reason_code] %></code></div>
                  <% end %>
                  <% if !j[:scheduling_intentional].nil? %>
                    <div class="pill <%= j[:scheduling_intentional] ? "sent" : "failed" %>"><%= j[:scheduling_intentional] ? "intentional" : "review config" %></div>
                  <% end %>
                </td>
                <td><span class="pill"><%= j[:job_scope] %></span></td>
                <td class="meta"><%= j[:context_label] %></td>
                <td><code><%= j[:active_job_id].presence || "-" %></code></td>
                <td class="job-details-cell">
                  <details>
                    <summary>inspect</summary>
                    <%= render "job_details", details: j[:details], job: j %>
                  </details>
                </td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No jobs found yet.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Active Processes</h2>
    <% if @processes.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-active-processes-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Kind</th>
              <th>PID</th>
              <th>Host</th>
              <th>Last heartbeat</th>
            </tr>
          </thead>
          <tbody>
            <% if @backend == "sidekiq" %>
              <% @processes.each do |p| %>
                <tr>
                  <td><code><%= p[:identity] %></code></td>
                  <td>sidekiq</td>
                  <td><%= p[:pid] %></td>
                  <td><%= p[:hostname] %></td>
                  <td><%= relative_time_with_tooltip(p[:beat]) %></td>
                </tr>
              <% end %>
            <% else %>
              <% @processes.each do |p| %>
                <tr>
                  <td><code><%= p.name %></code></td>
                  <td><%= p.kind %></td>
                  <td><%= p.pid %></td>
                  <td><%= p.hostname %></td>
                  <td><%= relative_time_with_tooltip(p.last_heartbeat_at) %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No worker processes found. Ensure `bin/jobs` is running.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Recent Queue Failures</h2>
    <% if @recent_failed.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-queue-failures-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Job</th>
              <th>Queue</th>
              <th>Scope</th>
              <th>Context</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody>
            <% if @backend == "sidekiq" %>
              <% @recent_failed.each do |f| %>
                <tr>
                  <td><%= relative_time_with_tooltip(f[:created_at]) %></td>
                  <td><code><%= f[:class_name] %></code></td>
                  <td><%= f[:queue_name] %></td>
                  <td><span class="pill"><%= f[:job_scope] %></span></td>
                  <td class="meta"><%= f[:context_label] %></td>
                  <td class="meta"><%= f[:error_message].to_s.truncate(180) %></td>
                </tr>
              <% end %>
            <% else %>
              <% @recent_failed.each do |f| %>
                <% j = f.try(:job) %>
                <% ctx = Jobs::ContextExtractor.from_solid_queue_job_arguments(j&.arguments || {}) %>
                <tr>
                  <td><%= relative_time_with_tooltip(f.created_at) %></td>
                  <td><code><%= j&.class_name || "?" %></code></td>
                  <td><%= j&.queue_name || "-" %></td>
                  <td><span class="pill"><%= ctx[:job_scope] %></span></td>
                  <td class="meta"><%= ctx[:context_label] %></td>
                  <td class="meta"><%= f.error.to_s.truncate(180) %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No failed executions found in queue backend.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Recent App Failure Logs</h2>
    <% if @failure_logs.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-app-failures-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Job</th>
              <th>Queue</th>
              <th>Scope</th>
              <th>Context</th>
              <th>Error</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @failure_logs.each do |f| %>
              <% scope = if f.instagram_profile_id.present? then "profile" elsif f.instagram_account_id.present? then "account" else "system" end %>
              <tr>
                <td><%= relative_time_with_tooltip(f.occurred_at) %></td>
                <td><code><%= f.job_class %></code></td>
                <td><%= f.queue_name %></td>
                <td><span class="pill"><%= scope %></span></td>
                <td class="meta">
                  <% if scope == "profile" %>
                    Profile #<%= f.instagram_profile_id %> (Account #<%= f.instagram_account_id || "?" %>)
                  <% elsif scope == "account" %>
                    Account #<%= f.instagram_account_id %>
                  <% else %>
                    System
                  <% end %>
                </td>
                <td class="meta"><%= f.error_message.to_s.truncate(160) %></td>
                <td><%= link_to "open", admin_background_job_failure_path(f), class: "btn small secondary" %></td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No app-level failures recorded yet.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Recent Application Issues</h2>
    <% if @recent_issues.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-recent-issues-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Issue</th>
              <th>Severity</th>
              <th>Status</th>
              <th>Occurrences</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_issues.each do |issue| %>
              <tr>
                <td><%= relative_time_with_tooltip(issue.last_seen_at) %></td>
                <td><%= issue.title %></td>
                <td><span class="pill"><%= issue.severity %></span></td>
                <td><span class="pill"><%= issue.status %></span></td>
                <td><%= issue.occurrences %></td>
                <td class="table-actions">
                  <%= button_to "Open",
                        admin_issue_path(issue),
                        method: :patch,
                        params: { status: "open" },
                        class: issue.status == "open" ? "btn small" : "btn small secondary" %>
                  <%= button_to "Pending",
                        admin_issue_path(issue),
                        method: :patch,
                        params: { status: "pending" },
                        class: issue.status == "pending" ? "btn small" : "btn small secondary" %>
                  <%= button_to "Resolve",
                        admin_issue_path(issue),
                        method: :patch,
                        params: { status: "resolved" },
                        class: issue.status == "resolved" ? "btn small" : "btn small secondary" %>
                  <% if issue.retryable? %>
                    <%= button_to "Retry Job", retry_job_admin_issue_path(issue), method: :post, class: "btn small secondary" %>
                  <% end %>
                  <%= link_to "Full Table", admin_issues_path, class: "btn small secondary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No application issues tracked yet.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Recent Active Storage Writes</h2>
    <% if @recent_storage_ingestions.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="admin-bg-storage-writes-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Attachment</th>
              <th>Record</th>
              <th>Size</th>
              <th>Job</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_storage_ingestions.each do |row| %>
              <% record_url =
                  case row.record_type
                  when "InstagramAccount"
                    instagram_account_path(row.record_id)
                  when "InstagramProfile"
                    instagram_profile_path(row.record_id)
                  when "InstagramPost"
                    instagram_post_path(row.record_id)
                  end %>
              <tr>
                <td><%= relative_time_with_tooltip(row.created_at) %></td>
                <td><code><%= row.attachment_name %></code> · <%= row.blob_filename %></td>
                <td>
                  <% if record_url.present? %>
                    <%= link_to "#{row.record_type}##{row.record_id}", record_url, class: "link-inline" %>
                  <% else %>
                    <%= row.record_type %>#<%= row.record_id %>
                  <% end %>
                </td>
                <td><%= number_to_human_size(row.blob_byte_size) %></td>
                <td><%= row.created_by_job_class.presence || "manual/request" %></td>
                <td class="table-actions">
                  <% if row.blob.present? %>
                    <%= link_to "Download",
                          rails_blob_path(row.blob, disposition: "attachment"),
                          class: "btn small secondary" %>
                  <% end %>
                  <% if record_url.present? %>
                    <%= link_to "Record", record_url, class: "btn small secondary" %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No Active Storage ingestion records yet.</p>
    <% end %>
  </section>
</div>
