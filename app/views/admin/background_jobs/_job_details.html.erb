<% details = details.is_a?(Hash) ? details : {} %>
<% processing_steps = Array(details[:processing_steps] || details["processing_steps"]) %>
<% final_output = details[:final_output] || details["final_output"] %>
<% api_responses = Array(details[:api_responses] || details["api_responses"]) %>
<% technical_data = Array(details[:technical_data] || details["technical_data"]) %>
<% blobs = Array(details[:blobs] || details["blobs"]) %>

<div class="stack job-details-stack">
  <div>
    <div class="meta"><strong>Processing Steps</strong></div>
    <% if processing_steps.any? %>
      <ol class="meta compact-numbered-list">
        <% processing_steps.each do |step| %>
          <li><%= step %></li>
        <% end %>
      </ol>
    <% else %>
      <p class="meta compact-meta-top">No processing steps recorded.</p>
    <% end %>
  </div>

  <div>
    <div class="meta"><strong>Final Output Result</strong></div>
    <% if final_output.present? %>
      <pre class="meta json-pre compact-meta-top"><%= JSON.pretty_generate(final_output) rescue final_output.to_json %></pre>
    <% else %>
      <p class="meta compact-meta-top">No final output captured yet.</p>
    <% end %>
  </div>

  <div>
    <div class="meta"><strong>Related API Responses</strong></div>
    <% if api_responses.any? %>
      <% api_responses.each do |api| %>
        <div class="meta compact-meta-block">
          <code><%= api[:provider] || api["provider"] %></code>
          · <code><%= api[:operation] || api["operation"] %></code>
          · status: <strong><%= api[:status] || api["status"] %></strong>
          <% if (api[:http_status] || api["http_status"]).present? %>
            · HTTP <%= api[:http_status] || api["http_status"] %>
          <% end %>
          <% if (api[:latency_ms] || api["latency_ms"]).present? %>
            · <%= api[:latency_ms] || api["latency_ms"] %> ms
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="meta compact-meta-top">No related API responses found for this job.</p>
    <% end %>
  </div>

  <div>
    <div class="meta"><strong>Generated Technical Data</strong></div>
    <% if technical_data.any? %>
      <% technical_data.each do |row| %>
        <div class="meta compact-meta-block">
          <strong><%= row[:source] || row["source"] %></strong>
        </div>
        <% payload = row[:payload] || row["payload"] %>
        <pre class="meta json-pre"><%= JSON.pretty_generate(payload) rescue payload.to_json %></pre>
      <% end %>
    <% else %>
      <p class="meta compact-meta-top">No technical artifacts linked to this job.</p>
    <% end %>
  </div>

  <div>
    <div class="meta"><strong>Associated Blobs / Stored Files</strong></div>
    <% if blobs.any? %>
      <% blobs.each do |blob| %>
        <div class="meta compact-meta-block">
          <code><%= blob[:blob_filename] || blob["blob_filename"] %></code>
          · <%= blob[:blob_content_type] || blob["blob_content_type"] || "unknown" %>
          · <%= number_to_human_size((blob[:blob_byte_size] || blob["blob_byte_size"]).to_i) %>
          · <%= (blob[:record_type] || blob["record_type"]).to_s %>#<%= (blob[:record_id] || blob["record_id"]).to_s %>
        </div>
      <% end %>
    <% else %>
      <p class="meta compact-meta-top">No blob/file writes recorded for this job.</p>
    <% end %>
  </div>
</div>
