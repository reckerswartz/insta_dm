<% content_for :title, "AI Providers" %>

<div class="page">
  <header class="page-header">
    <h1>AI Providers</h1>
    <p class="meta">Enable one or more providers, set priority, configure keys, and validate connectivity.</p>
  </header>

  <% @settings.each do |setting| %>
    <section class="card">
      <h2><%= setting.display_name %></h2>

      <%= form_with model: setting, url: admin_ai_provider_path(setting), method: :patch, class: "stack" do |f| %>
        <div class="filters">
          <label class="checkbox">
            <%= f.check_box :enabled %>
            Enabled
          </label>

          <label>
            Priority
            <%= f.number_field :priority, min: 0, step: 1 %>
          </label>

          <label>
            Model (optional)
            <%= text_field_tag "ai_provider_setting[model]", setting.config_value("model"), placeholder: "Provider model override" %>
          </label>

          <label>
            Comment model (optional)
            <%= text_field_tag "ai_provider_setting[comment_model]", setting.config_value("comment_model"), placeholder: "gemini-2.0-flash" %>
          </label>

          <label>
            Project ID (optional)
            <%= text_field_tag "ai_provider_setting[project_id]", setting.config_value("project_id"), placeholder: "Project / resource id" %>
          </label>

          <label>
            Endpoint (optional)
            <%= text_field_tag "ai_provider_setting[endpoint]", setting.config_value("endpoint"), placeholder: "https://<resource>.cognitiveservices.azure.com" %>
          </label>

          <label>
            Access Key ID (optional)
            <%= text_field_tag "ai_provider_setting[access_key_id]", setting.config_value("access_key_id"), placeholder: "AWS access key id" %>
          </label>

          <label>
            Region (optional)
            <%= text_field_tag "ai_provider_setting[region]", setting.config_value("region"), placeholder: "us-east-1" %>
          </label>

          <label>
            API Version (optional)
            <%= text_field_tag "ai_provider_setting[api_version]", setting.config_value("api_version"), placeholder: "2024-02-01" %>
          </label>

          <label>
            Daily limit (optional)
            <%= number_field_tag "ai_provider_setting[daily_limit]", setting.config_value("daily_limit"), min: 0, step: 1, placeholder: "e.g. 100" %>
          </label>

          <label>
            API Key
            <%= password_field_tag "ai_provider_setting[api_key]", nil, autocomplete: "off", placeholder: setting.api_key_present? ? "Stored (leave blank to keep)" : "Enter API key" %>
          </label>

          <label class="checkbox">
            <%= check_box_tag "ai_provider_setting[clear_api_key]", "1", false %>
            Clear stored key
          </label>
        </div>

        <div class="meta">
          Effective key source:
          <strong><%= setting.api_key.to_s.present? ? "Dashboard setting" : "Rails credentials" %></strong>
          | Provider code: <code><%= setting.provider %></code>
        </div>

        <div class="actions-row">
          <%= f.submit "Save", class: "btn" %>
        </div>
      <% end %>

      <div class="actions-row">
        <%= button_to "Test Key", test_key_admin_ai_provider_path(setting), method: :post, class: "btn secondary", data: { turbo_confirm: "Run connectivity test for #{setting.display_name}?" } %>
      </div>
    </section>
  <% end %>
</div>
