<!DOCTYPE html>
<html lang="en">
  <head>
    <% page_title = content_for?(:title) ? yield(:title) : "Insta DM" %>
    <title><%= page_title %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="description" content="Instagram DM management and analytics platform">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "tabulator.min", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= yield :styles %>
    <% if Rails.env.development? && ENV["WEBPACK_DEV_SERVER"] == "true" %>
      <%= javascript_include_tag "http://127.0.0.1:3035/application.js", "data-turbo-track": "reload", defer: true, crossorigin: "anonymous" %>
    <% else %>
      <%= javascript_include_tag "application", "data-turbo-track": "reload", defer: true %>
    <% end %>
  </head>

  <body class="app-body">
    <a class="skip-link" href="#mainContent">Skip to main content</a>
    <div class="app-shell" id="appShell">
      <aside class="app-sidebar" id="appSidebar" aria-label="Primary navigation">
        <div class="sidebar-brand-row">
          <div class="sidebar-brand-mark">ID</div>
          <div>
            <h1 class="sidebar-brand">InstaManager</h1>
            <p class="sidebar-brand-subtitle">Operations Console</p>
          </div>
        </div>

        <nav class="sidebar-nav" role="navigation" aria-label="Main">
          <%= top_nav_link_to instagram_accounts_path, section: :accounts, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">DB</span>
            <span>Dashboard</span>
          <% end %>

          <%= top_nav_link_to instagram_profiles_path, section: :profiles, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">PF</span>
            <span>Profiles</span>
          <% end %>

          <%= top_nav_link_to ai_dashboard_index_path, section: :ai_dashboard, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">AI</span>
            <span>AI Dashboard</span>
          <% end %>

          <%= top_nav_link_to admin_background_jobs_path, section: :jobs, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">JB</span>
            <span>Jobs</span>
          <% end %>

          <%= top_nav_link_to admin_background_job_failures_path, section: :failures, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">FL</span>
            <span>Failures</span>
          <% end %>

          <%= top_nav_link_to admin_issues_path, section: :issues, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">IS</span>
            <span>Issues</span>
          <% end %>

          <%= top_nav_link_to admin_storage_ingestions_path, section: :storage, class: "sidebar-link" do %>
            <span class="sidebar-link-icon" aria-hidden="true">ST</span>
            <span>Storage</span>
          <% end %>
        </nav>

        <div class="sidebar-footer">
          <span class="status-dot"></span>
          <span>Session Active</span>
        </div>
      </aside>

      <div class="app-main">
        <header class="app-topbar">
          <button
            type="button"
            class="btn small secondary sidebar-toggle-btn"
            id="sidebarToggleBtn"
            aria-label="Toggle navigation"
            aria-expanded="false"
          >
            Navigation
          </button>

          <div class="topbar-page-title"><%= page_title %></div>

          <div class="topbar-account" role="status" aria-live="polite">
            <% if current_account %>
              <span class="muted">Current account</span>
              <%= link_to current_account.username, instagram_account_path(current_account), class: "topbar-account-link", title: "Open current account dashboard" %>
            <% else %>
              <span class="pill">No account selected</span>
            <% end %>
          </div>
        </header>

        <div class="flash-stack">
          <% if flash[:notice] %>
            <div class="alert alert-success alert-dismissible fade show" role="alert" aria-live="polite">
              <div><%= flash[:notice] %></div>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>

          <% if flash[:alert] %>
            <div class="alert alert-warning alert-dismissible fade show" role="alert" aria-live="assertive">
              <div><%= flash[:alert] %></div>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>
        </div>

        <div id="notifications" role="status" aria-live="polite" aria-label="Application notifications"></div>

        <%= render "shared/modals" %>

        <main class="app-content" id="mainContent" role="main">
          <%= yield %>
        </main>
      </div>
    </div>

    <%= yield :javascript %>

    <script>
      document.addEventListener("turbo:load", function() {
        const toggleBtn = document.getElementById("sidebarToggleBtn");
        const body = document.body;
        const sidebar = document.getElementById("appSidebar");

        if (!toggleBtn || toggleBtn.dataset.bound === "1") return;
        toggleBtn.dataset.bound = "1";

        toggleBtn.addEventListener("click", function() {
          const isOpen = body.classList.toggle("sidebar-open");
          toggleBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        });

        sidebar?.querySelectorAll("a").forEach(function(link) {
          link.addEventListener("click", function() {
            if (window.innerWidth > 1024) return;
            body.classList.remove("sidebar-open");
            toggleBtn.setAttribute("aria-expanded", "false");
          });
        });

        document.addEventListener("click", function(event) {
          if (window.innerWidth > 1024) return;
          if (!sidebar) return;

          const clickedInsideSidebar = sidebar.contains(event.target);
          const clickedToggle = toggleBtn.contains(event.target);

          if (!clickedInsideSidebar && !clickedToggle) {
            body.classList.remove("sidebar-open");
            toggleBtn.setAttribute("aria-expanded", "false");
          }
        });

        document.addEventListener("keydown", function(event) {
          if (event.key !== "Escape") return;
          if (!body.classList.contains("sidebar-open")) return;
          body.classList.remove("sidebar-open");
          toggleBtn.setAttribute("aria-expanded", "false");
        });

        window.addEventListener("resize", function() {
          if (window.innerWidth <= 1024) return;
          body.classList.remove("sidebar-open");
          toggleBtn.setAttribute("aria-expanded", "false");
        });

        setTimeout(function() {
          const alerts = document.querySelectorAll(".alert");
          alerts.forEach(function(alert) {
            if (!window.bootstrap || !bootstrap.Alert) return;
            bootstrap.Alert.getOrCreateInstance(alert).close();
          });
        }, 5000);
      });
    </script>
  </body>
</html>
