<% queue = actions_todo_queue.is_a?(Hash) ? actions_todo_queue : {} %>
<% stats = queue[:stats].is_a?(Hash) ? queue[:stats] : {} %>
<% items = Array(queue[:items]).first(5) %>
<% refreshed_time = begin Time.zone.parse(stats[:refreshed_at].to_s) rescue nil end %>

<section id="actions_to_be_done_section" class="card">
  <div class="actions-row workspace-actions-summary-header">
    <div>
      <h2>Actions to Be Done</h2>
      <p class="meta">Optimized queue now runs in <strong>Workspace</strong>. Processing continues in background while profile and post analysis complete.</p>
    </div>
    <%= link_to "Open Workspace Queue", actions_workspace_path, class: "btn" %>
  </div>

  <div class="workspace-actions-summary-stats">
    <span class="pill queued">Total: <%= stats[:total_items].to_i %></span>
    <span class="pill sent">Ready: <%= stats[:ready_items].to_i %></span>
    <span class="pill running">Processing: <%= stats[:processing_items].to_i %></span>
    <span class="pill queued">Queued: <%= stats[:queued_items].to_i %></span>
    <span class="pill partial">Partial: <%= stats[:partial_items].to_i %></span>
    <span class="pill failed">Failed: <%= stats[:failed_items].to_i %></span>
    <span class="pill">Enqueued now: <%= stats[:enqueued_now].to_i %></span>
    <% if stats[:enqueue_blocked_reason].to_s.present? %>
      <span class="pill failed">Enqueue paused: <%= stats[:enqueue_blocked_reason].to_s.humanize %></span>
    <% end %>
    <% if refreshed_time.present? %>
      <span class="meta">Refreshed <%= relative_time_with_tooltip(refreshed_time) %></span>
    <% end %>
  </div>

  <% if items.any? %>
    <div class="table-scroll">
      <table class="table workspace-actions-summary-table">
        <thead>
          <tr>
            <th>Profile</th>
            <th>Post</th>
            <th>Status</th>
            <th>Suggestions</th>
          </tr>
        </thead>
        <tbody>
          <% items.each do |item| %>
            <% post = item[:post] %>
            <% profile = item[:profile] %>
            <% suggestions = Array(item[:suggestions]) %>
            <tr>
              <td>
                <%= link_to "@#{profile.username}", instagram_profile_path(profile), class: "link-inline" %>
              </td>
              <td class="meta">
                <code><%= post.shortcode %></code><br>
                <%= post.caption.to_s.truncate(90) %>
              </td>
              <td class="meta"><%= item[:processing_message].to_s.presence || item[:processing_status].to_s.humanize %></td>
              <td class="meta"><%= suggestions.any? ? suggestions.first(2).join(" | ") : "In progress" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="meta">No pending user-post actions. New queue items will appear in Workspace automatically.</p>
  <% end %>
</section>
