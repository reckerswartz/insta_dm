<% content_for :title, "Dashboard" %>
<% queue = @metrics[:queue] || {} %>
<% app = @metrics[:app] || {} %>
<% usage = @metrics[:api_usage_24h] || {} %>

<div class="page dashboard-page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1>Dashboard</h1>
      <p class="meta mb-0">Manage account health, sync workload, and daily AI throughput.</p>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Profiles", instagram_profiles_path, class: "btn secondary" %>
      <%= link_to "Feed Posts", instagram_posts_path, class: "btn secondary" %>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
        Add Account
      </button>
    </div>
  </header>

  <section class="card">
    <h2>System Snapshot</h2>
    <div class="metric-grid">
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:profiles].to_i %></span>
        <span class="metric-label-small">Profiles</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:followers].to_i %></span>
        <span class="metric-label-small">Followers</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:following].to_i %></span>
        <span class="metric-label-small">Following</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:messages].to_i %></span>
        <span class="metric-label-small">Messages</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:posts].to_i %></span>
        <span class="metric-label-small">Feed Posts</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:ai_analyses].to_i %></span>
        <span class="metric-label-small">AI Analyses</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:ai_api_calls].to_i %></span>
        <span class="metric-label-small">API Calls</span>
      </div>
      <div class="metric-item-small highlight">
        <span class="metric-value-small"><%= app[:failures_24h].to_i %></span>
        <span class="metric-label-small">24h Failures</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:auth_failures_24h].to_i %></span>
        <span class="metric-label-small">24h Auth Failures</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:active_issues].to_i %></span>
        <span class="metric-label-small">Open Issues</span>
      </div>
      <div class="metric-item-small">
        <span class="metric-value-small"><%= app[:storage_ingestions_24h].to_i %></span>
        <span class="metric-label-small">Storage Writes (24h)</span>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Queue and API Usage</h2>
    <div class="stat-grid">
      <div class="stat">
        <div class="stat-label">Queue</div>
        <div class="stat-kv"><span class="muted">Backend</span><strong><%= queue[:backend].to_s == "sidekiq" ? "Sidekiq" : "Solid Queue" %></strong></div>
        <% if queue[:backend].to_s == "sidekiq" %>
          <div class="stat-kv"><span class="muted">Enqueued</span><strong><%= queue[:enqueued].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Scheduled</span><strong><%= queue[:scheduled].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Retries</span><strong><%= queue[:retries].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Dead</span><strong><%= queue[:dead].to_i %></strong></div>
        <% else %>
          <div class="stat-kv"><span class="muted">Ready</span><strong><%= queue[:ready].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Scheduled</span><strong><%= queue[:scheduled].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Claimed</span><strong><%= queue[:claimed].to_i %></strong></div>
          <div class="stat-kv"><span class="muted">Failed</span><strong><%= queue[:failed].to_i %></strong></div>
        <% end %>
      </div>

      <div class="stat">
        <div class="stat-label">AI API Usage (24h)</div>
        <div class="stat-kv"><span class="muted">Total calls</span><strong><%= usage[:total_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Image analysis</span><strong><%= usage[:image_analysis_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Report generation</span><strong><%= usage[:report_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Text generation</span><strong><%= usage[:text_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Failed calls</span><strong><%= usage[:failed_calls].to_i %></strong></div>
      </div>

      <div class="stat">
        <div class="stat-label">Top Operations (24h)</div>
        <% operations = usage[:top_operations] || {} %>
        <% if operations.any? %>
          <% operations.each do |operation, count| %>
            <div class="stat-kv"><span class="muted"><%= operation %></span><strong><%= count %></strong></div>
          <% end %>
        <% else %>
          <p class="meta mb-0">No API calls recorded in the last 24 hours.</p>
        <% end %>
      </div>
    </div>

    <div class="quick-actions mt-3">
      <%= link_to "Jobs Console", admin_background_jobs_path, class: "quick-action-btn" %>
      <%= link_to "Failure Logs", admin_background_job_failures_path, class: "quick-action-btn" %>
      <%= link_to "Issues", admin_issues_path, class: "quick-action-btn" %>
      <%= link_to "Storage", admin_storage_ingestions_path, class: "quick-action-btn" %>
      <%= link_to "Feed Posts", instagram_posts_path, class: "quick-action-btn" %>
    </div>
  </section>

  <section class="card">
    <h2>Instagram Accounts</h2>
    <p class="card-description">Open account settings, switch active context, and clean up stale accounts.</p>

    <% if @accounts.any? %>
      <div class="accounts-table">
        <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="accounts-table" data-table-standard-pagination-size-value="25">
          <div class="table-scroll">
            <table class="table" data-table-standard-target="table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Status</th>
                <th>Cookies</th>
                <th>Last Sync</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @accounts.each do |account| %>
                <tr>
                  <td><strong><%= account.username %></strong></td>
                  <td>
                    <% if account.login_state == "authenticated" %>
                      <span class="status-badge authenticated">Authenticated</span>
                    <% else %>
                      <span class="status-badge unauthenticated"><%= account.login_state %></span>
                    <% end %>
                  </td>
                  <td>
                    <% if account.cookies.any? %>
                      <span class="yes">Stored</span>
                    <% else %>
                      <span class="no">Missing</span>
                    <% end %>
                  </td>
                  <td><%= relative_time_with_tooltip(account.last_synced_at) %></td>
                  <td>
                    <div class="table-actions">
                      <%= button_to "Select", select_instagram_account_path(account), method: :post, class: "btn small secondary", form: { data: { turbo: false } } %>
                      <%= link_to "Manage", instagram_account_path(account), class: "btn small" %>
                      <%= button_to "Delete",
                            instagram_account_path(account),
                            method: :delete,
                            class: "btn small danger",
                            form: {
                              data: {
                                confirm_modal: true,
                                confirm_title: "Delete account?",
                                confirm_message: "Delete @#{account.username} and all related data? This action cannot be undone.",
                                modal_loading_text: "Deleting account..."
                              }
                            } %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
            </table>
          </div>
        </div>
      </div>
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">+</div>
        <h3>No accounts connected</h3>
        <p>Add your first account to start sync and messaging workflows.</p>
      </div>
    <% end %>
  </section>
</div>

<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAccountModalLabel">Add Instagram Account</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="addAccountForm" action="<%= instagram_accounts_path %>" method="post" novalidate>
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <div class="modal-body">
          <label for="instagram_account_username" class="form-label">Instagram Username</label>
          <div class="input-group">
            <span class="input-group-text">@</span>
            <input type="text" class="form-control" id="instagram_account_username" name="instagram_account[username]" placeholder="username" required>
          </div>
          <p class="meta mt-2 mb-0">Authentication is handled on the account management screen after creation.</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="addAccountBtn">
            <span class="btn-text">Add Account</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    document.addEventListener("turbo:load", function() {
      const form = document.getElementById("addAccountForm")
      const submitBtn = document.getElementById("addAccountBtn")
      const modalElement = document.getElementById("addAccountModal")
      if (!form || !submitBtn || !modalElement || form.dataset.bound === "1") return
      form.dataset.bound = "1"

      const modal = window.bootstrap?.Modal?.getOrCreateInstance(modalElement)
      if (!modal) return

      form.addEventListener("submit", function(event) {
        event.preventDefault()
        if (!form.reportValidity()) return

        submitBtn.classList.add("btn-loading")
        submitBtn.disabled = true
        submitBtn.querySelector(".btn-text").textContent = "Adding..."

        fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: {
            "Accept": "text/html",
            "X-Requested-With": "XMLHttpRequest"
          }
        })
          .then((response) => {
            if (!response.ok) throw new Error("Unable to add account")
            modal.hide()
            form.reset()
            if (window.showSuccessModal) {
              showSuccessModal("Account Added", "Account created successfully.")
            }
            setTimeout(() => window.location.reload(), 900)
          })
          .catch((error) => {
            if (window.showErrorModal) {
              showErrorModal("Error", error.message || "Unable to add account")
            }
          })
          .finally(() => {
            submitBtn.classList.remove("btn-loading")
            submitBtn.disabled = false
            submitBtn.querySelector(".btn-text").textContent = "Add Account"
          })
      })
    })
  </script>
<% end %>
