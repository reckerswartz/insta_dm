<% content_for :title, "Dashboard" %>

<div class="page">
  <header class="page-header">
    <h1>Dashboard</h1>
    <p>Manage your Instagram accounts and monitor system performance</p>
  </header>

  <section class="card">
    <h2>‚ûï Add New Account</h2>
    <p class="card-description">Add an Instagram account to start monitoring and managing your social media presence</p>
    <%= form_with url: instagram_accounts_path, method: :post, scope: :instagram_account, class: "add-account-form" do |f| %>
      <label>
        Instagram Username
        <%= f.text_field :username, placeholder: "@username", required: true, class: "form-input" %>
      </label>
      <div class="actions-row">
        <%= f.submit "Add Account", class: "btn btn-primary" %>
      </div>
    <% end %>
  </section>

  <section class="card">
    <h2>üìä System Overview</h2>
    <p class="card-description">Real-time system metrics and performance indicators</p>

    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-header">
          <h3>üîÑ Queue Status</h3>
          <% q = @metrics[:queue] || {} %>
          <% if q[:backend].to_s == "sidekiq" %>
            <span class="metric-badge sidekiq">Sidekiq</span>
          <% else %>
            <span class="metric-badge solid-queue">Solid Queue</span>
          <% end %>
        </div>
        <div class="metric-value"><%= q[:processes].to_i %> <span class="metric-unit">processes</span></div>
          <% total = q.values_at(:enqueued, :scheduled, :retries, :dead).sum.to_i %>
          <% total = 1 if total <= 0 %>
        <div class="metric-details">
          <% if q[:backend].to_s == "sidekiq" %>
            <% total = q.values_at(:enqueued, :scheduled, :retries, :dead).sum.to_i %>
            <% total = 1 if total <= 0 %>
            <div class="metric-item">
              <span class="metric-label">Enqueued</span>
              <div class="progress-bar">
                <div class="progress-fill ok" style="width:<%= (q[:enqueued].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:enqueued].to_i %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Scheduled</span>
              <div class="progress-bar">
                <div class="progress-fill" style="width:<%= (q[:scheduled].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:scheduled].to_i %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Retries</span>
              <div class="progress-bar">
                <div class="progress-fill warn" style="width:<%= (q[:retries].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:retries].to_i %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Failed</span>
              <div class="progress-bar">
                <div class="progress-fill bad" style="width:<%= (q[:dead].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:dead].to_i %></span>
            </div>
          <% else %>
            <% total = q.values_at(:ready, :scheduled, :claimed, :blocked, :failed).sum.to_i %>
            <% total = 1 if total <= 0 %>
            <div class="metric-item">
              <span class="metric-label">Ready</span>
              <div class="progress-bar">
                <div class="progress-fill ok" style="width:<%= (q[:ready].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:ready] %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Scheduled</span>
              <div class="progress-bar">
                <div class="progress-fill" style="width:<%= (q[:scheduled].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:scheduled] %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Claimed</span>
              <div class="progress-bar">
                <div class="progress-fill" style="width:<%= (q[:claimed].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:claimed] %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Blocked</span>
              <div class="progress-bar">
                <div class="progress-fill warn" style="width:<%= (q[:blocked].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:blocked] %></span>
            </div>
            <div class="metric-item">
              <span class="metric-label">Failed</span>
              <div class="progress-bar">
                <div class="progress-fill bad" style="width:<%= (q[:failed].to_f / total * 100).round(1) %>%"></div>
              </div>
              <span class="metric-number"><%= q[:failed] %></span>
            </div>
          <% end %>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-header">
          <h3>üìà Application Totals</h3>
        </div>
        <div class="metric-grid">
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :accounts) %></span>
            <span class="metric-label-small">Accounts</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :profiles) %></span>
            <span class="metric-label-small">Profiles</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :messages) %></span>
            <span class="metric-label-small">Messages</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :profile_events) %></span>
            <span class="metric-label-small">Events</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :ai_analyses) %></span>
            <span class="metric-label-small">AI Analyses</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :ai_api_calls) %></span>
            <span class="metric-label-small">API Calls</span>
          </div>
          <div class="metric-item-small">
            <span class="metric-value-small"><%= @metrics.dig(:app, :posts) %></span>
            <span class="metric-label-small">Feed Posts</span>
          </div>
          <div class="metric-item-small highlight">
            <span class="metric-value-small"><%= @metrics.dig(:app, :failures_24h) %></span>
            <span class="metric-label-small">24h Failures</span>
          </div>
        </div>
      </div>
    </div>

    <% usage = @metrics[:api_usage_24h] || {} %>
    <div class="stat-grid" style="margin-top: 12px;">
      <div class="stat">
        <div class="stat-label">AI API Usage (24h)</div>
        <div class="stat-kv"><span class="muted">Total calls</span><strong><%= usage[:total_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Image analysis</span><strong><%= usage[:image_analysis_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Report generation</span><strong><%= usage[:report_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Text generation</span><strong><%= usage[:text_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Failed calls</span><strong><%= usage[:failed_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Avg latency</span><strong><%= usage[:avg_latency_ms].to_i %> ms</strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Top API Operations (24h)</div>
        <% operations = usage[:top_operations] || {} %>
        <% if operations.any? %>
          <% operations.each do |op, count| %>
            <div class="stat-kv"><span class="muted"><%= op %></span><strong><%= count %></strong></div>
          <% end %>
        <% else %>
          <p class="meta">No API calls recorded in the last 24 hours.</p>
        <% end %>
      </div>
    </div>

    <div class="quick-actions">
      <%= link_to "‚öôÔ∏è Jobs Console", admin_background_jobs_path, class: "quick-action-btn" %>
      <%= link_to "üö® Failure Logs", admin_background_job_failures_path, class: "quick-action-btn" %>
      <%= link_to "üì± Feed Posts", instagram_posts_path, class: "quick-action-btn" %>
    </div>
  </section>

  <section class="card">
    <h2>üë• Instagram Accounts</h2>
    <p class="card-description">Manage and monitor your connected Instagram accounts</p>

    <% if @accounts.any? %>
      <div class="accounts-table">
        <div class="table-scroll">
          <table class="table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Status</th>
                <th>Cookies</th>
                <th>Last Sync</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @accounts.each do |a| %>
                <tr>
                  <td>
                    <div class="account-info">
                      <strong class="username"><%= a.username %></strong>
                    </div>
                  </td>
                  <td>
                    <% if a.login_state == "authenticated" %>
                      <span class="status-badge authenticated">Authenticated</span>
                    <% else %>
                      <span class="status-badge unauthenticated"><%= a.login_state %></span>
                    <% end %>
                  </td>
                  <td>
                    <% if a.cookies.any? %>
                      <span class="yes">‚úÖ Stored</span>
                    <% else %>
                      <span class="no">‚ùå None</span>
                    <% end %>
                  </td>
                  <td>
                    <span class="sync-time"><%= relative_time_with_tooltip(a.last_synced_at) %></span>
                  </td>
                  <td class="table-actions">
                    <%= button_to "Select", select_instagram_account_path(a), method: :post, class: "btn small secondary" %>
                    <%= link_to "Manage", instagram_account_path(a), class: "btn small" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <div class="empty-state">
        <div class="empty-icon">üì±</div>
        <h3>No accounts added yet</h3>
        <p>Add your first Instagram account to get started with monitoring and management.</p>
      </div>
    <% end %>
  </section>
</div>
