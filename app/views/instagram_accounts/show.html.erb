<% content_for :title, @account.username %>
<% actions_queue = @actions_todo_queue.is_a?(Hash) ? @actions_todo_queue : {} %>
<% actions_queue_stats = actions_queue[:stats].is_a?(Hash) ? actions_queue[:stats] : {} %>

<div class="page">
  <header class="page-header page-toolbar">
    <div class="page-toolbar-main">
      <h1><%= @account.username %></h1>
      <p class="meta">
        Login state: <strong><%= @account.login_state %></strong>
        <% if @account.last_synced_at %>
          | Last sync: <strong><%= relative_time_with_tooltip(@account.last_synced_at) %></strong>
        <% end %>
      </p>
    </div>
    <div class="page-toolbar-actions">
      <%= link_to "Dashboard", instagram_accounts_path, class: "btn secondary" %>
      <%= link_to "Workspace Queue", actions_workspace_path, class: "btn secondary" %>
    </div>
  </header>

  <section class="card">
    <h2>Current Status</h2>
    <div class="stat-grid profile-overview-grid">
      <div class="stat">
        <div class="stat-label">Authentication</div>
        <div class="stat-kv"><span class="muted">State</span><strong><%= @account.login_state.to_s.presence || "-" %></strong></div>
        <div class="stat-kv"><span class="muted">Cookie auth</span><strong><%= @account.cookie_authenticated? ? "Valid" : "Needs attention" %></strong></div>
        <div class="stat-kv"><span class="muted">Session cookie</span><strong><%= @account.sessionid_cookie_present? ? "Present" : "Missing" %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Latest Sync</div>
        <div class="stat-kv"><span class="muted">Status</span><strong><%= @latest_sync_run&.status.to_s.presence || "No runs yet" %></strong></div>
        <div class="stat-kv"><span class="muted">Started</span><strong><%= relative_time_with_tooltip(@latest_sync_run&.started_at) %></strong></div>
        <div class="stat-kv"><span class="muted">Finished</span><strong><%= relative_time_with_tooltip(@latest_sync_run&.finished_at) %></strong></div>
      </div>
      <div class="stat">
        <div class="stat-label">Workspace Queue</div>
        <div class="stat-kv"><span class="muted">Total</span><strong><%= actions_queue_stats[:total_items].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Ready</span><strong><%= actions_queue_stats[:ready_items].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Processing</span><strong><%= actions_queue_stats[:processing_items].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Failed</span><strong><%= actions_queue_stats[:failed_items].to_i %></strong></div>
      </div>
    </div>
  </section>

  <%= render "account_health_auth_section" %>

  <section
    class="card"
    data-controller="story-media-archive llm-comment technical-details"
    data-story-media-archive-url-value="<%= story_media_archive_instagram_account_path(@account) %>"
    data-story-media-archive-account-id-value="<%= @account.id %>"
    data-story-media-archive-autoload-value="true"
    data-llm-comment-account-id-value="<%= @account.id %>"
    data-technical-details-account-id-value="<%= @account.id %>"
  >
    <h2>Downloaded Story Archive</h2>
    <p class="meta">Dynamically loads archived story media with infinite scrolling. Cards highlight current pipeline state, actionable decision reasons, and send status.</p>

    <div class="actions-row">
      <button type="button" class="btn" data-story-media-archive-target="loadButton" data-action="story-media-archive#bootstrap">Load Archive</button>
      <label>
        Date filter
        <input type="date" data-story-media-archive-target="dateInput" data-action="change->story-media-archive#changeDate" />
      </label>
      <label>
        LLM status
        <select data-story-media-archive-target="statusSelect" data-action="change->story-media-archive#changeStatus">
          <option value="">All</option>
          <option value="queued">Queued</option>
          <option value="running">Running</option>
          <option value="failed">Failed</option>
          <option value="skipped">Skipped</option>
          <option value="completed">Completed</option>
          <option value="not_requested">Not requested</option>
        </select>
      </label>
      <label>
        Failure reason code
        <input
          type="text"
          placeholder="e.g. policy_blocked"
          data-story-media-archive-target="reasonCodeInput"
          data-action="change->story-media-archive#changeReasonCode"
          list="story-archive-reason-code-suggestions"
        />
      </label>
      <datalist id="story-archive-reason-code-suggestions">
        <option value="policy_blocked"></option>
        <option value="insufficient_verified_signals"></option>
        <option value="local_microservice_unavailable"></option>
        <option value="vision_model_error"></option>
      </datalist>
      <button type="button" class="btn secondary" data-action="story-media-archive#refresh">Refresh</button>
      <span class="meta">Max cycles per continuous run: <strong><%= InstagramAccountsController::CONTINUOUS_STORY_SYNC_CYCLE_LIMIT %></strong></span>
    </div>

    <div class="story-media-scroll" data-story-media-archive-target="scroll" data-action="scroll->story-media-archive#onScroll">
      <div class="story-media-grid" data-story-media-archive-target="gallery"></div>
      <p class="meta" data-story-media-archive-target="empty" hidden>No archived stories found for selected filters.</p>
      <p class="meta" data-story-media-archive-target="loader">Loading story mediaâ€¦</p>
    </div>
    <div id="story_media_archive_refresh_signal" data-story-media-archive-target="refreshSignal" hidden></div>

    <div
      class="technical-details-modal hidden"
      data-technical-details-target="modal"
      data-action="click->technical-details#handleBackdropClick"
    >
      <div class="modal-content" data-action="click->technical-details#stopPropagation">
        <div class="loading-indicator" data-technical-details-target="loading" hidden>
          <div class="loading-spinner"></div>
          <p>Loading technical details...</p>
        </div>
        <div class="error-message" data-technical-details-target="error" hidden></div>
        <div class="technical-details-body" data-technical-details-target="details" hidden></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Sync & Workload</h2>
    <% capture_locked = feed_capture_enqueue_locked?(account: @account) %>
    <% next_allowed_at = feed_capture_next_allowed_at(account: @account) %>

    <div class="actions-row">
      <%= button_to "Sync Followers/Following (Background)", follow_graph_sync_path, method: :post %>
      <%= button_to "Sync Next 10 Stories", sync_profile_stories_instagram_account_path(@account, story_limit: InstagramAccountsController::STORY_SYNC_LIMIT), method: :post, class: "btn secondary" %>
      <%= button_to "Run Continuous Processing Now", run_continuous_processing_instagram_account_path(@account), method: :post, class: "btn secondary" %>
    </div>
    <details class="details-box mt-2">
      <summary>Advanced workload actions</summary>
      <div class="actions-row mt-2">
        <%= button_to "Sync Next 10 Stories (Auto Reply Enabled)", sync_stories_with_comments_instagram_account_path(@account, story_limit: InstagramAccountsController::STORY_SYNC_LIMIT), method: :post, class: "btn secondary" %>
        <%= button_to "Sync All Stories (Continuous Auto Reply)", sync_all_stories_continuous_instagram_account_path(@account), method: :post, class: "btn secondary" %>
        <%= button_to "Download Missing Avatars (Background)", download_missing_avatars_instagram_profiles_path, method: :post, class: "btn secondary" %>
        <%= button_to(capture_locked ? "Capture Feed (Queued)" : "Capture Feed (Background)",
              feed_capture_path(rounds: 4, delay_seconds: 45, max_new: 20),
              method: :post,
              class: "btn secondary",
              disabled: capture_locked,
              form: { data: { turbo_submits_with: "Queueing..." } }) %>
      </div>
    </details>
    <p class="meta">
      <% if capture_locked && next_allowed_at.present? %>
        Feed capture is already queued/running. Next manual trigger is available <strong><%= relative_time_with_tooltip(next_allowed_at) %></strong>.
      <% else %>
        Manual capture is ready. Autonomous capture is also handled by the continuous-processing scheduler.
      <% end %>
    </p>

    <div id="sync_status">
      <%= render "sync_runs/status", sync_run: @latest_sync_run %>
    </div>

    <div class="stat-grid">
      <div class="stat">
        <div class="stat-label">Account Totals</div>
        <div class="stat-kv"><span class="muted">Profiles</span><strong><%= @metrics.dig(:app, :profiles) %></strong></div>
        <div class="stat-kv"><span class="muted">Followers</span><strong><%= @metrics.dig(:app, :followers) %></strong></div>
        <div class="stat-kv"><span class="muted">Following</span><strong><%= @metrics.dig(:app, :following) %></strong></div>
        <div class="stat-kv"><span class="muted">Messages</span><strong><%= @metrics.dig(:app, :messages) %></strong></div>
        <div class="stat-kv"><span class="muted">Feed posts</span><strong><%= @metrics.dig(:app, :posts) %></strong></div>
        <details class="details-box mt-2">
          <summary>Show extended totals</summary>
          <div class="stat-kv"><span class="muted">Mutuals</span><strong><%= @metrics.dig(:app, :mutuals) %></strong></div>
          <div class="stat-kv"><span class="muted">AI analyses</span><strong><%= @metrics.dig(:app, :ai_analyses) %></strong></div>
          <div class="stat-kv"><span class="muted">AI API calls</span><strong><%= @metrics.dig(:app, :ai_api_calls) %></strong></div>
        </details>
      </div>

      <div class="stat">
        <div class="stat-label">Work (24h)</div>
        <div class="stat-kv"><span class="muted">Failures</span><strong><%= @metrics.dig(:app, :failures_24h) %></strong></div>
        <div class="stat-kv"><span class="muted">Sync runs</span><strong><%= @metrics.dig(:app, :sync_runs) %></strong></div>
        <div class="stat-kv"><span class="muted">Events</span><strong><%= @metrics.dig(:app, :profile_events) %></strong></div>
      </div>
    </div>

    <div class="stat-grid mt-section">
      <div class="stat">
        <div class="stat-label">Sync Runs By Status</div>
        <% counts = (@metrics[:sync_runs_by_status] || {}).transform_keys(&:to_s) %>
        <% total = counts.values.sum.to_i; total = 1 if total <= 0 %>
        <% counts.sort_by { |k, _| k }.each do |k, v| %>
          <div class="bar-row">
            <span class="bar-label"><%= k %></span>
            <div class="bar"><div class="bar-fill" style="width:<%= (v.to_f / total * 100).round(1) %>%"></div></div>
            <span class="bar-num"><%= v %></span>
          </div>
        <% end %>
        <% if counts.empty? %>
          <p class="meta">No sync runs recorded yet.</p>
        <% end %>
      </div>

      <div class="stat">
        <div class="stat-label">AI Analyses By Status</div>
        <% counts = (@metrics[:analyses_by_status] || {}).transform_keys(&:to_s) %>
        <% total = counts.values.sum.to_i; total = 1 if total <= 0 %>
        <% counts.sort_by { |k, _| k }.each do |k, v| %>
          <div class="bar-row">
            <span class="bar-label"><%= k %></span>
            <div class="bar"><div class="bar-fill" style="width:<%= (v.to_f / total * 100).round(1) %>%"></div></div>
            <span class="bar-num"><%= v %></span>
          </div>
        <% end %>
        <% if counts.empty? %>
          <p class="meta">No analyses recorded yet.</p>
        <% end %>
      </div>
    </div>

    <% usage = @metrics[:api_usage_24h] || {} %>
    <div class="stat-grid mt-section">
      <div class="stat">
        <div class="stat-label">AI API Usage (24h)</div>
        <div class="stat-kv"><span class="muted">Total calls</span><strong><%= usage[:total_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Image analysis</span><strong><%= usage[:image_analysis_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Report generation</span><strong><%= usage[:report_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Text generation</span><strong><%= usage[:text_generation_calls].to_i %></strong></div>
        <div class="stat-kv"><span class="muted">Failed calls</span><strong><%= usage[:failed_calls].to_i %></strong></div>
        <details class="details-box mt-2">
          <summary>Show providers and token totals</summary>
          <div class="stat-kv"><span class="muted">Total tokens</span><strong><%= usage[:total_tokens].to_i %></strong></div>
          <% providers = usage[:by_provider] || {} %>
          <% if providers.any? %>
            <% providers.sort_by { |k, _| k }.each do |provider, count| %>
              <div class="stat-kv"><span class="muted"><%= provider %></span><strong><%= count %></strong></div>
            <% end %>
          <% else %>
            <p class="meta mb-0">No provider activity in the last 24 hours.</p>
          <% end %>
        </details>
      </div>
    </div>
  </section>

  <%= render "feed_capture_activity_section", account: @account, feed_capture_activity_entries: @feed_capture_activity_entries %>

  <%= render "actions_to_be_done_section", actions_todo_queue: @actions_todo_queue %>

  <%= render "skip_diagnostics_section", skip_diagnostics: @skip_diagnostics %>

  <%= render "audit_logs_section", recent_audit_entries: @recent_audit_entries %>

  <section class="card">
    <h2>Recent Failures (This Account)</h2>

    <% if @recent_failures.any? %>
      <div class="tabulator-shell" data-controller="table-standard" data-table-standard-storage-key-value="account-recent-failures-table" data-table-standard-pagination-size-value="25">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Job</th>
              <th>Error</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @recent_failures.each do |f| %>
              <tr>
                <td><%= relative_time_with_tooltip(f.occurred_at) %></td>
                <td><code><%= f.job_class %></code></td>
                <td class="meta"><%= "#{f.error_class}: #{f.error_message}".truncate(180) %></td>
                <td><%= link_to "open", admin_background_job_failure_path(f), class: "btn small secondary" %></td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
    <% else %>
      <p class="meta">No recent failures tied to this account.</p>
    <% end %>
  </section>

  <section class="card">
    <h2>Danger Zone</h2>
    <p class="meta">Deleting an account will delete its profiles, messages, and history.</p>
    <div class="actions-row">
      <%= button_to "Delete Account",
            instagram_account_path(@account),
            method: :delete,
            class: "btn danger",
            form: {
              data: {
                confirm_modal: true,
                confirm_title: "Delete account?",
                confirm_message: "Delete #{@account.username} and all related data?",
                modal_loading_text: "Deleting account..."
              }
            } %>
    </div>
  </section>
</div>
