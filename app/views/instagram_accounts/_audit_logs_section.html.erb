<section id="account_audit_logs_section" class="card">
  <h2>Audit Logs (Latest First)</h2>
  <p class="meta">Tracks automated actions and events such as story viewed, story analyzed, and comment posting activity.</p>

  <% if recent_audit_entries.any? %>
    <div data-controller="audit-media-modal table-standard" data-table-standard-storage-key-value="account-audit-logs-table" data-table-standard-pagination-size-value="25">
      <div class="tabulator-shell">
        <div class="table-scroll">
          <table class="table" data-table-standard-target="table">
          <thead>
            <tr>
              <th>When</th>
              <th>Type</th>
              <th>Profile</th>
              <th>Activity</th>
              <th>Status</th>
              <th>Details</th>
              <th>Media</th>
            </tr>
          </thead>
          <tbody>
            <% recent_audit_entries.each do |entry| %>
              <tr>
                <td><%= relative_time_with_tooltip(entry[:occurred_at]) %></td>
                <td><%= entry[:type] %></td>
                <td>
                  <% if entry[:profile_username].present? %>
                    <% if entry[:profile_id].present? %>
                      <%= link_to "@" + entry[:profile_username].to_s, instagram_profile_path(entry[:profile_id]), class: "link-inline" %>
                    <% else %>
                      <code>@<%= entry[:profile_username] %></code>
                    <% end %>
                    <span class="meta">
                      <%= link_to "IG", "https://www.instagram.com/#{entry[:profile_username]}/", target: "_blank", rel: "noopener noreferrer", class: "link-inline" %>
                    </span>
                  <% else %>
                    <code>-</code>
                  <% end %>
                </td>
                <td><%= entry[:kind].to_s.tr("_", " ").titleize %></td>
                <td><span class="pill <%= entry[:status] == "failed" ? "failed" : (entry[:status] == "succeeded" ? "sent" : "queued") %>"><%= entry[:status] %></span></td>
                <td class="meta">
                  <%= entry[:detail].to_s.truncate(220) %>
                  <% if entry[:skip_reason].present? %>
                    <div><code><%= entry[:skip_reason] %></code></div>
                  <% end %>
                  <% if entry[:comment_text].present? %>
                    <details>
                      <summary>View Comment</summary>
                      <pre class="meta json-pre audit-comment-pre"><%= entry[:comment_text] %></pre>
                    </details>
                  <% end %>
                </td>
                <td>
                  <div class="d-flex flex-wrap gap-2">
                    <% if entry[:media_url].present? && entry[:media_modal_supported] %>
                      <button
                        type="button"
                        class="btn small secondary"
                        data-action="audit-media-modal#open"
                        data-media-url="<%= entry[:media_url] %>"
                        data-media-download-url="<%= entry[:media_download_url] %>"
                        data-media-content-type="<%= entry[:media_content_type] %>"
                        data-media-preview-image-url="<%= entry[:media_preview_image_url] %>"
                        data-video-static-frame-only="<%= entry[:video_static_frame_only] %>"
                        data-profile-id="<%= entry[:profile_id] %>"
                        data-profile-username="<%= entry[:profile_username] %>"
                        data-activity-kind="<%= entry[:kind] %>"
                        data-occurred-at="<%= entry[:occurred_at]&.strftime("%Y-%m-%d %H:%M:%S") %>"
                      >
                        View
                      </button>
                    <% elsif entry[:media_url].present? %>
                      <a class="btn small secondary" href="<%= entry[:media_url] %>" target="_blank" rel="noopener noreferrer">View</a>
                    <% elsif entry[:skip_event] %>
                      <button type="button" class="btn small secondary" disabled>View</button>
                    <% else %>
                      <span class="meta">-</span>
                    <% end %>

                    <% if entry[:media_download_url].present? %>
                      <a class="btn small secondary" href="<%= entry[:media_download_url] %>" target="_blank" rel="noopener noreferrer">Download</a>
                    <% elsif entry[:skip_event] %>
                      <button type="button" class="btn small secondary" disabled>Download</button>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
          </table>
        </div>
      </div>
      <div class="modal fade app-media-modal" tabindex="-1" aria-hidden="true" data-audit-media-modal-target="modal">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" data-audit-media-modal-target="title">Audit Media</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-7">
                  <img data-audit-media-modal-target="image" alt="Audit media preview" class="modal-media-image img-fluid rounded border border-secondary-subtle" />
                  <div data-audit-media-modal-target="videoShell" class="story-video-player-shell audit-video-player-shell d-none">
                    <video
                      data-audit-media-modal-target="video"
                      data-controller="video-player"
                      data-video-player-autoplay-value="false"
                      data-video-player-load-on-play-value="true"
                      controls
                      playsinline
                      preload="none"
                    ></video>
                  </div>
                </div>
                <div class="col-lg-5 d-grid gap-2 align-content-start">
                  <p class="meta mb-0">
                    Profile:
                    <a data-audit-media-modal-target="appProfileLink" href="#">-</a>
                    <span class="meta">|</span>
                    <a data-audit-media-modal-target="instagramProfileLink" href="#" target="_blank" rel="noopener noreferrer">IG</a>
                  </p>
                  <p class="meta mb-0" data-audit-media-modal-target="meta"></p>
                  <div class="d-flex flex-wrap gap-2">
                    <a data-audit-media-modal-target="download" class="btn btn-sm btn-outline-light" href="#" target="_blank" rel="noreferrer">Download media</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <p class="meta">No audit activity recorded yet.</p>
  <% end %>
</section>
