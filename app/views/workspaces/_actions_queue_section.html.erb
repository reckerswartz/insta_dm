<% rows = Array(queue_result[:items]) %>
<% stats = queue_result[:stats].is_a?(Hash) ? queue_result[:stats] : {} %>
<% refreshed_time = begin Time.zone.parse(stats[:refreshed_at].to_s) rescue nil end %>
<% service_queue_metrics = Array(stats[:service_queue_metrics]) %>
<% ordering_rule = stats[:ordering_rule].to_s.presence %>

<div class="workspace-actions-stats-row">
  <span class="pill queued">Total: <%= stats[:total_items].to_i %></span>
  <span class="pill sent">Ready: <%= stats[:ready_items].to_i %></span>
  <span class="pill running">Processing: <%= stats[:processing_items].to_i %></span>
  <span class="pill queued">Queued: <%= stats[:queued_items].to_i %></span>
  <span class="pill partial">Partial: <%= stats[:partial_items].to_i %></span>
  <span class="pill failed">Failed: <%= stats[:failed_items].to_i %></span>
  <span class="pill">Avg progress: <%= stats[:average_progress_percent].to_i %>%</span>
  <span class="pill">Enqueued now: <%= stats[:enqueued_now].to_i %></span>
  <% if stats[:enqueue_blocked_reason].to_s.present? %>
    <span class="pill failed">Enqueue paused: <%= stats[:enqueue_blocked_reason].to_s.humanize %></span>
  <% end %>
  <% if refreshed_time.present? %>
    <span class="meta">Updated <%= relative_time_with_tooltip(refreshed_time) %></span>
  <% end %>
</div>
<% if ordering_rule.present? %>
  <p class="meta workspace-ordering-note"><strong>Queue order:</strong> <%= ordering_rule %></p>
<% end %>

<% if service_queue_metrics.any? %>
  <div class="workspace-actions-stats-row">
    <% service_queue_metrics.each do |row| %>
      <% service_name = row[:service].to_s.humanize %>
      <% pending = row[:pending].to_i %>
      <% row_class = pending.positive? ? "queued" : "sent" %>
      <span class="pill <%= row_class %>"><%= service_name %>: <%= pending %></span>
    <% end %>
  </div>
<% end %>

<% if rows.any? %>
  <div class="table-scroll workspace-actions-table-scroll">
    <table class="table workspace-actions-table">
      <thead>
        <tr>
          <th class="workspace-col-order">Queue</th>
          <th>Posted by</th>
          <th>Preview</th>
          <th>Post data</th>
          <th>Suggested comments</th>
          <th>Status</th>
          <th class="workspace-col-actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% rows.each do |item| %>
          <% post = item[:post] %>
          <% profile = item[:profile] %>
          <% metadata = item[:metadata].is_a?(Hash) ? item[:metadata] : {} %>
          <% suggestions = Array(item[:suggestions]).first(3) %>
          <% status = item[:processing_status].to_s %>
          <% lifecycle_state = item[:lifecycle_state].to_s.presence || "queued" %>
          <% queue_rank = item[:queue_rank].to_i %>
          <% queue_priority_label = item[:queue_priority_label].to_s.presence || lifecycle_state.humanize %>
          <% queue_priority_reason = item[:queue_priority_reason].to_s.presence || status.humanize %>
          <% progress_completed = item[:progress_completed].to_i %>
          <% progress_total = item[:progress_total].to_i %>
          <% progress_percent = item[:progress_percent].to_i %>
          <% stage_log = Array(item[:stage_log]) %>
          <% stage_rows = Array(item[:stage_rows]) %>
          <% insights = item[:engagement_insights].is_a?(Hash) ? item[:engagement_insights] : {} %>
          <% send_enabled = ActiveModel::Type::Boolean.new.cast(item[:send_enabled]) %>
          <% status_class =
              case lifecycle_state
              when "ready"
                "sent"
              when "failed"
                "failed"
              when "processing"
                "running"
              when "partial"
                "partial"
              else
                "queued"
              end %>
          <% processing_status_class =
               case status
               when "failed"
                 "failed"
               when "running", "waiting_post_analysis", "waiting_comment_generation", "waiting_build_history", "waiting_profile_analysis"
                 "running"
               when "ready"
                 "sent"
               when "skipped_unsuitable_content", "skipped_page_profile", "skipped_deleted_source", "skipped_non_user_post"
                 "partial"
               else
                 "queued"
               end %>
          <% avatar_url =
              if profile.avatar.attached?
                rails_blob_path(profile.avatar, only_path: true)
              else
                profile.profile_pic_url.to_s.presence
              end %>

          <% media_content_type =
              if post.media.attached?
                post.media.blob&.content_type.to_s
              else
                metadata["media_content_type"].to_s
              end %>
          <% is_video = media_content_type.start_with?("video/") || metadata["media_type"].to_i == 2 %>
          <% preview_url =
              if post.media.attached? && !is_video
                rails_blob_path(post.media, only_path: true)
              elsif is_video
                preferred_profile_post_preview_image_url(post: post, metadata: metadata)
              else
                metadata["preview_image_url"].to_s.presence ||
                  metadata["poster_url"].to_s.presence ||
                  metadata["image_url"].to_s.presence ||
                  metadata["media_url_image"].to_s.presence
              end %>
          <% media_download_url = post.media.attached? ? rails_blob_path(post.media, disposition: "attachment") : nil %>

          <tr>
            <td class="workspace-col-order">
              <div class="workspace-queue-rank">#<%= queue_rank %></div>
              <span class="pill <%= status_class %>"><%= queue_priority_label %></span>
              <p class="meta compact-meta-top"><%= queue_priority_reason %></p>
            </td>
            <td>
              <div class="workspace-profile-cell">
                <% if avatar_url.present? %>
                  <img src="<%= avatar_url %>" alt="<%= profile.username %> avatar" class="workspace-profile-avatar" loading="lazy" />
                <% else %>
                  <span class="workspace-profile-avatar workspace-profile-avatar-placeholder">?</span>
                <% end %>
                <div>
                  <strong><%= profile.display_name.presence || profile.username %></strong>
                  <div class="meta">
                    <%= link_to "@#{profile.username}", instagram_profile_path(profile), class: "link-inline" %>
                  </div>
                </div>
              </div>
            </td>
            <td>
              <% if preview_url.present? %>
                <img src="<%= preview_url %>" alt="Post preview" class="table-preview-thumb" loading="lazy" />
              <% else %>
                <span class="meta">Preview pending</span>
              <% end %>
            </td>
            <td class="meta">
              <code><%= post.shortcode %></code><br>
              <%= post.caption.to_s.truncate(110) %><br>
              <span>Taken: <%= relative_time_with_tooltip(post.taken_at) %></span><br>
              <%= link_to "Open Post", post.permalink_url, target: "_blank", rel: "noopener noreferrer", class: "link-inline" %>
              <% if media_download_url.present? %>
                | <a href="<%= media_download_url %>" target="_blank" rel="noreferrer" class="link-inline">Download</a>
              <% end %>
            </td>
            <td>
              <% if suggestions.any? %>
                <p class="meta compact-meta-top"><strong><%= suggestions.size %></strong> suggestions ready</p>
                <details class="details-box workspace-suggestions-details">
                  <summary>View and send</summary>
                  <ol class="compact-numbered-list tight">
                    <% suggestions.each_with_index do |text, idx| %>
                      <li class="meta">
                        <span><%= text %></span>
                        <span class="workspace-suggestion-actions">
                          <%= button_to "Send ##{idx + 1}",
                                forward_comment_instagram_profile_instagram_profile_post_path(profile, post, comment: text),
                                method: :post,
                                disabled: !send_enabled,
                                class: "btn small secondary" %>
                        </span>
                      </li>
                    <% end %>
                  </ol>
                </details>
                <% unless send_enabled %>
                  <p class="meta compact-meta-top">Send is disabled by engagement policy.</p>
                <% end %>
              <% else %>
                <span class="meta">Suggestions pending</span>
              <% end %>
            </td>
            <td>
              <span class="pill <%= status_class %>"><%= lifecycle_state.humanize %></span>
              <span class="pill <%= processing_status_class %>"><%= status.humanize %></span>
              <p class="meta compact-meta-top"><%= item[:processing_message].to_s.presence || "Queued for background processing." %></p>
              <div class="workspace-progress-meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= progress_percent %>">
                <span class="workspace-progress-fill" style="width: <%= progress_percent %>%"></span>
              </div>
              <p class="meta compact-meta-top">Progress: <strong><%= progress_completed %>/<%= progress_total %></strong> steps (<%= progress_percent %>%)</p>
              <% if insights.any? %>
                <p class="meta compact-meta-top">
                  Type: <%= insights[:content_type].to_s.presence || "unknown" %>,
                  Ownership: <%= insights[:ownership].to_s.presence || "unknown" %>,
                  Suitable: <%= insights.key?(:engagement_suitable) ? (insights[:engagement_suitable] ? "yes" : "no") : "n/a" %>
                </p>
              <% end %>
              <% if stage_rows.any? %>
                <details class="details-box workspace-suggestions-details">
                  <summary>Pipeline stages</summary>
                  <ul class="compact-list tight meta">
                    <% stage_rows.each do |row| %>
                      <li>
                        <strong><%= row[:label].to_s %>:</strong>
                        <%= row[:state].to_s.humanize %>
                        <% if row[:updated_at].to_s.present? %>
                          (<%= relative_time_with_tooltip(Time.zone.parse(row[:updated_at].to_s)) rescue row[:updated_at].to_s %>)
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </details>
              <% end %>
              <% if stage_log.any? %>
                <details class="details-box workspace-suggestions-details">
                  <summary>Stage log</summary>
                  <ul class="compact-list tight meta">
                    <% stage_log.last(10).reverse_each do |log_entry| %>
                      <li>
                        <strong><%= log_entry[:stage].to_s.humanize %></strong> â†’
                        <%= log_entry[:status].to_s.humanize %>
                        <% if log_entry[:at].to_s.present? %>
                          (<%= relative_time_with_tooltip(Time.zone.parse(log_entry[:at].to_s)) rescue log_entry[:at].to_s %>)
                        <% end %>
                        <% if log_entry[:message].to_s.present? %>
                          - <%= log_entry[:message].to_s %>
                        <% end %>
                      </li>
                    <% end %>
                  </ul>
                </details>
              <% end %>
            </td>
            <td class="table-actions workspace-col-actions">
              <%= link_to "View Profile", instagram_profile_path(profile), class: "btn small secondary" %>
              <%= button_to "Retry Suggestions",
                    analyze_instagram_profile_instagram_profile_post_path(profile, post),
                    method: :post,
                    params: {
                      analyze_visual: false,
                      analyze_faces: false,
                      run_ocr: false,
                      run_video: false,
                      run_metadata: true,
                      generate_comments: true,
                      enforce_comment_evidence_policy: false,
                      retry_on_incomplete_profile: false
                    },
                    class: "btn small secondary" %>
              <%= button_to "Retry Full Pipeline",
                    analyze_instagram_profile_instagram_profile_post_path(profile, post),
                    method: :post,
                    params: {
                      analyze_visual: true,
                      analyze_faces: false,
                      run_ocr: false,
                      run_video: true,
                      run_metadata: true,
                      generate_comments: true,
                      enforce_comment_evidence_policy: true,
                      retry_on_incomplete_profile: true,
                      regenerate_all: true
                    },
                    class: "btn small secondary" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <p class="meta">No user-post action items are pending. New captured posts will appear here automatically.</p>
<% end %>
